<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wi-Fi Heatmap ‚Äî Planning (AP Model) + Obstacles ‚Äî Smooth + Probe</title>
<style>
  :root{ --bg:#0f1220; --panel:#171a2b; --muted:#9aa4b2; --text:#e8ecf1;
         --card:#1b2035; --btn:#232845; --ring:#2a7fff55; --danger:#ff7b7b; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(120deg,#0f1220,#0e1428 60%,#0f1220);
       color:var(--text);font:500 16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  header{padding:14px 18px;border-bottom:1px solid #202540;background:rgba(17,22,36,.7);
         position:sticky;top:0;backdrop-filter:blur(8px);z-index:50}
  header h1{margin:0;font-size:18px}
  .container{display:grid;grid-template-columns:380px 1fr;gap:14px;padding:14px;height:calc(100% - 64px)}
  .panel{background:var(--panel);border:1px solid #242a49;border-radius:14px;padding:14px;overflow:auto}
  .section{margin-bottom:14px;padding-bottom:12px;border-bottom:1px dashed #2a3156}
  .section:last-child{border-bottom:0;margin-bottom:0;padding-bottom:0}
  .label{font-size:13px;color:var(--muted);margin:6px 0 6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="file"],input[type="number"],input[type="text"],select{
    background:var(--card);border:1px solid #2a3156;color:var(--text);
    border-radius:10px;padding:8px 10px;outline:none
  }
  input[type="number"]{width:120px}
  button{
    background:var(--btn);border:1px solid #2a3156;color:var(--text);padding:9px 12px;border-radius:11px;
    cursor:pointer;transition:.15s;user-select:none
  }
  button:hover{transform:translateY(-1px);box-shadow:0 6px 18px -10px #000,0 0 0 2px var(--ring)}
  button.danger{background:#3a1b1b;border-color:#5a2a2a;color:#ffc6c6}
  .chip{font-size:12px;border:1px solid #2a3156;border-radius:999px;padding:4px 9px;color:var(--muted);display:inline-flex;gap:6px;align-items:center}
  .legend{display:flex;align-items:center;gap:10px}
  .grad{width:220px;height:12px;border-radius:999px;border:1px solid #2a3156}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#222846;border:1px solid #2a3156;border-radius:6px;padding:2px 6px;color:#b9c3ff;font-size:12px}
  .muted{color:var(--muted)}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#22284a;border:1px solid #2a3156}
  .small{font-size:12px}
  .apRow,.matRow{display:flex;justify-content:space-between;gap:8px;align-items:center;background:#141a34;border:1px solid #2a3156;border-radius:10px;padding:6px 8px}
  .dot{width:10px;height:10px;border-radius:50%}
  @media (max-width:980px){ .container{grid-template-columns:1fr} }

  /* probe tooltip */
  .stage{position:relative}
  #probe{position:absolute;display:none;transform:translate(10px,-10px);
         background:#0e1329;border:1px solid #2a3156;border-radius:10px;padding:6px 8px;
         color:#e8ecf1;font:600 13px ui-monospace,monospace;pointer-events:none;z-index:5;
         box-shadow:0 6px 20px rgba(0,0,0,.35)}
  #probe .sw{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;border:1px solid #0006}
  #probe .sub{font-weight:500;color:#9aa4b2;margin-top:2px}
</style>
</head>
<body>
<header><h1>üì∂ Wi-Fi Heatmap ‚Äî Planning (AP Model) + Obstacles ‚Äî Smooth + Probe</h1></header>

<div class="container">
  <!-- Left control panel -->
  <aside class="panel">
    <div class="section">
      <div class="label">1) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏õ‡∏•‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (PNG/JPG)</div>
      <div class="row">
        <input type="file" id="fileInput" accept="image/*" />
        <button id="btnClear">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
    </div>

    <div class="section">
      <div class="label">2) ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á</div>
      <div class="row">
        <button id="btnScale">üß≠ ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏• (‡∏•‡∏≤‡∏Å 2 ‡∏à‡∏∏‡∏î)</button>
        <span class="chip">‡∏™‡πÄ‡∏Å‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="scaleLabel">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á</span></span>
      </div>
      <div class="small muted">‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡∏≠‡∏±‡∏ï‡∏£‡∏≤ px/‡πÄ‡∏°‡∏ï‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å AP ‚Üí ‡∏ó‡∏∏‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î</div>
    </div>

    <div class="section">
      <div class="label">3) ‡∏ß‡∏≤‡∏á Access Point</div>
      <div class="grid">
        <div>
          <div class="label">‡∏ä‡∏∑‡πà‡∏≠/SSID</div>
          <input type="text" id="apLabel" placeholder="‡πÄ‡∏ä‡πà‡∏ô AP-1" />
        </div>
        <div>
          <div class="label">P‚ÇÄ @1 m (dBm)</div>
          <input type="number" id="apP0" value="-40" step="1" />
        </div>
        <div>
          <div class="label">n (Path-loss exponent)</div>
          <input type="number" id="apN" value="2.2" step="0.1" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnAP">üì° ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏á AP (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà)</button>
        <button id="btnAPUndo" class="ghost">‚Ü©Ô∏è ‡∏•‡∏ö AP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        <button id="btnAPClear" class="danger">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á AP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
      <div id="apList" style="margin-top:10px;display:grid;gap:6px;"></div>
      <div class="small muted">‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢ AP ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á (mW) ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô dBm</div>
    </div>

    <div class="section">
      <div class="label">4) ‡∏ß‡∏±‡∏™‡∏î‡∏∏/‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á (‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô)</div>
      <div class="grid">
        <div>
          <div class="label">‡∏ä‡∏ô‡∏¥‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏</div>
          <select id="matType"></select>
        </div>
        <div>
          <div class="label">‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏Å‡∏•‡∏∑‡∏ô (dB/‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
          <input type="number" id="matAtt" value="8" step="0.5" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnMat">üß± ‡πÇ‡∏´‡∏°‡∏î‡∏•‡∏≤‡∏Å‡∏ß‡∏±‡∏™‡∏î‡∏∏ (‡∏Ñ‡∏•‡∏¥‡∏Å-‡∏•‡∏≤‡∏Å 2 ‡∏à‡∏∏‡∏î)</button>
        <button id="btnMatUndo" class="ghost">‚Ü©Ô∏è ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        <button id="btnMatClear" class="danger">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
      <div id="matList" style="margin-top:10px;display:grid;gap:6px;"></div>
    </div>

    <div class="section">
      <div class="label">5) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
      <div class="grid">
        <div>
          <div class="label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô Blur (px)</div>
          <input type="number" id="blurPx" value="16" min="0" step="1" />
        </div>
        <div>
          <div class="label">‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡∏Æ‡∏µ‡∏ï‡πÅ‡∏°‡∏õ</div>
          <input type="number" id="alpha" value="0.6" min="0" max="1" step="0.05" />
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnRender">üî• ‡∏™‡∏£‡πâ‡∏≤‡∏á Heatmap</button>
        <button id="btnExport">üñºÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PNG</button>
      </div>
      <div class="legend" style="margin-top:10px">
        <div id="grad" class="grad"></div>
        <div class="small"><span id="legendMin">-80</span> dBm ‚ü∑ <span id="legendMax">-50</span> dBm</div>
      </div>
      <div class="small muted">‡πÇ‡∏ó‡∏ô‡∏™‡∏µ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà: ‡πÅ‡∏î‡∏á (‚àí80 dBm) ‚Üí ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß (‚àí50 dBm)</div>
    </div>

    <div class="section">
      <div class="label">6) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå</div>
      <div class="row">
        <button id="btnSave">üíæ Save JSON</button>
        <input type="file" id="loadJson" accept="application/json" />
      </div>
    </div>

    <div class="section small muted">
      ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î: <span class="kbd">S</span> ‡∏™‡πÄ‡∏Å‡∏• ‚Ä¢ <span class="kbd">A</span> ‡∏ß‡∏≤‡∏á AP ‚Ä¢ <span class="kbd">W</span> ‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‚Ä¢ <span class="kbd">H</span> ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Ä¢ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ö‡∏ô‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏û‡∏∑‡πà‡∏≠ ‚ÄúProbe‚Äù ‡∏Ñ‡πà‡∏≤ RSSI
    </div>
  </aside>

  <!-- Right workspace -->
  <main class="panel stage" id="stage">
    <div class="row">
      <span class="badge" id="modeBadge">‡πÇ‡∏´‡∏°‡∏î: Planning</span>
      <span class="muted small">‡∏•‡∏≥‡∏î‡∏±‡∏ö: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û ‚Üí ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏• ‚Üí ‡∏ß‡∏≤‡∏á AP ‚Üí ‡∏ß‡∏≤‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‚Üí ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Üí ‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡πà‡∏≤ RSSI</span>
    </div>
    <canvas id="canvas" width="1280" height="800"></canvas>
    <div id="probe">
      <div><span class="sw" id="sw"></span><span id="probeVal">‚Äì dBm</span></div>
      <div class="sub" id="probeMeta"></div>
    </div>
  </main>
</div>

<script>
/* ========= Fixed thresholds ========= */
const RSSI_MIN = -80;  // ‡πÅ‡∏î‡∏á
const RSSI_MAX = -50;  // ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß

/* ========= Utilities ========= */
const $ = sel => document.querySelector(sel);
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const dist = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
function getCanvasPos(e){
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width  / rect.width;
  const scaleY = canvas.height / rect.height;
  return { x:(e.clientX-rect.left)*scaleX, y:(e.clientY-rect.top)*scaleY, rect };
}
function download(filename, data, type="application/json"){
  const blob = new Blob([data], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ========= Materials ========= */
const MATERIALS = {
  drywall:  {name:'‡∏ú‡∏ô‡∏±‡∏á‡∏¢‡∏¥‡∏õ‡∏ã‡∏±‡∏° (Drywall)', color:'#98c1ff', att:3},
  glass:    {name:'‡∏Å‡∏£‡∏∞‡∏à‡∏Å',                 color:'#7de1ff', att:4},
  wood:     {name:'‡πÑ‡∏°‡πâ',                   color:'#9ae27b', att:5},
  brick:    {name:'‡∏≠‡∏¥‡∏ê/‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡∏°‡∏ß‡∏•‡πÄ‡∏ö‡∏≤',    color:'#ffb673', att:8},
  concrete: {name:'‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏´‡∏•‡πá‡∏Å',    color:'#ff8f8f', att:12},
  metal:    {name:'‡πÇ‡∏•‡∏´‡∏∞‡πÅ‡∏ú‡πà‡∏ô/‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÄ‡∏´‡∏•‡πá‡∏Å',   color:'#ffd36a', att:20},
  human:    {name:'‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏Ñ‡∏ô (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)',     color:'#d6b3ff', att:3}
};
const matTypeSel = $('#matType');
for(const k of Object.keys(MATERIALS)){
  const opt = document.createElement('option'); opt.value=k; opt.textContent=MATERIALS[k].name; matTypeSel.appendChild(opt);
}
matTypeSel.value = 'brick';
$('#matAtt').value = MATERIALS['brick'].att;
matTypeSel.addEventListener('change', ()=>{
  const k = matTypeSel.value; $('#matAtt').value = MATERIALS[k].att;
});

/* ========= Canvas & State ========= */
const canvas = $('#canvas');
const ctx = canvas.getContext('2d', { willReadFrequently:true });

let floorImg = null;
let aps = [];       // {x,y,label,p0,n}
let segments = [];  // {a:{x,y}, b:{x,y}, type, att}
let mode = 'idle';  // 'scale'|'ap'|'mat'
let scale = { pxPerMeter: null };
let tempLine = null;
let hasRendered = false; // ‡πÄ‡∏õ‡∏¥‡∏î probe ‡∏´‡∏•‡∏±‡∏á render ‡πÅ‡∏•‡πâ‡∏ß

const UI = {
  scaleLabel: $('#scaleLabel'),
  modeBadge: $('#modeBadge'),
  apList: $('#apList'),
  matList: $('#matList'),
  legendMin: $('#legendMin'),
  legendMax: $('#legendMax'),
  probe: $('#probe'),
  probeVal: $('#probeVal'),
  probeMeta: $('#probeMeta'),
  probeSw: $('#sw'),
  stage: $('#stage')
};

/* ========= Image handling ========= */
function fitCanvasToImage(img){
  const maxW = 1920, maxH = 1080;
  const k = Math.min(maxW/img.width, maxH/img.height, 1);
  canvas.width = Math.round(img.width*k);
  canvas.height = Math.round(img.height*k);
}

function drawBase(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(floorImg){ ctx.drawImage(floorImg,0,0,canvas.width,canvas.height); }
  else {
    ctx.fillStyle = '#0c1022'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = '#1c264a'; ctx.lineWidth = 1;
    for(let x=0;x<canvas.width;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke()}
    for(let y=0;y<canvas.height;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke()}
  }
  hideProbe();
}

function drawOverlays(){
  // ‡∏ß‡∏±‡∏™‡∏î‡∏∏
  ctx.lineWidth = 3;
  segments.forEach(s=>{
    const m = MATERIALS[s.type] || {color:'#fff',name:s.type};
    ctx.strokeStyle = m.color; ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    const mx=(s.a.x+s.b.x)/2, my=(s.a.y+s.b.y)/2;
    ctx.fillStyle = '#e8ecf1'; ctx.font='11px ui-monospace,monospace';
    ctx.fillText(`${m.name} ¬∑ ${s.att} dB`, mx+6, my-6);
  });

  // ‡πÄ‡∏™‡πâ‡∏ô‡∏ä‡∏±‡πà‡∏ß‡∏Ñ‡∏£‡∏≤‡∏ß (scale/material)
  if(tempLine){
    ctx.strokeStyle='#8fd3ff'; ctx.setLineDash([8,6]); ctx.lineWidth=2.5;
    ctx.beginPath(); ctx.moveTo(tempLine.a.x,tempLine.a.y); ctx.lineTo(tempLine.b.x,tempLine.b.y); ctx.stroke();
    ctx.setLineDash([]);
    const Lpx = dist(tempLine.a,tempLine.b);
    ctx.fillStyle='#8fd3ff'; ctx.font='12px ui-monospace,monospace';
    ctx.fillText(`${Lpx.toFixed(1)} px`, tempLine.b.x+8, tempLine.b.y-6);
  }

  // APs
  aps.forEach(a=>{
    ctx.fillStyle = '#8fd3ff';
    ctx.beginPath(); ctx.arc(a.x,a.y,7,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#2a7fff'; ctx.lineWidth=2; ctx.stroke();
    ctx.fillStyle='#cfe6ff'; ctx.font='12px ui-monospace,monospace';
    ctx.fillText(`${a.label||'AP'} ¬∑ P0:${a.p0}dBm n:${a.n}`, a.x+10, a.y-8);
  });
}

/* ========= Fixed red‚Üígreen palette ========= */
function makeFixedLegend(){
  const g = $('#grad'); const cvs = document.createElement('canvas');
  cvs.width=256; cvs.height=1; const c=cvs.getContext('2d');
  const gr=c.createLinearGradient(0,0,256,0);
  gr.addColorStop(0,'#ff0000'); gr.addColorStop(1,'#00ff00');
  c.fillStyle=gr; c.fillRect(0,0,256,1);
  g.style.backgroundImage = `url(${cvs.toDataURL()})`;
}
function colorFromRSSI(v){ // return [r,g,0]
  const t = clamp((v - RSSI_MIN) / (RSSI_MAX - RSSI_MIN), 0, 1);
  return [Math.round(255*(1-t)), Math.round(255*t), 0];
}
function rgbStr([r,g,b]){ return `rgb(${r},${g},${b})`; }

/* ========= Geometry / materials ========= */
function orient(a,b,c){ return (b.x-a.x)*(c.y-a.y) - (b.y-a.y)*(c.x-a.x); }
function onSeg(a,b,c){ return Math.min(a.x,b.x)-1e-6<=c.x && c.x<=Math.max(a.x,b.x)+1e-6 &&
                               Math.min(a.y,b.y)-1e-6<=c.y && c.y<=Math.max(a.y,b.y)+1e-6; }
function segIntersect(p1,p2,q1,q2){
  const o1=orient(p1,p2,q1), o2=orient(p1,p2,q2);
  const o3=orient(q1,q2,p1), o4=orient(q1,q2,p2);
  if((o1*o2<0)&&(o3*o4<0)) return true;
  if(Math.abs(o1)<1e-8 && onSeg(p1,p2,q1)) return true;
  if(Math.abs(o2)<1e-8 && onSeg(p1,p2,q2)) return true;
  if(Math.abs(o3)<1e-8 && onSeg(q1,q2,p1)) return true;
  if(Math.abs(o4)<1e-8 && onSeg(q1,q2,p2)) return true;
  return false;
}
function pathObstacleLoss(pFrom, pTo){
  let loss=0;
  for(const s of segments){ if(segIntersect(pFrom,pTo,s.a,s.b)) loss += (Number(s.att)||0); }
  return loss;
}

/* ========= AP Model ========= */
// RSSI(d) = P0 - 10*n*log10(d) - obstacleLoss ; d in meters
function rssiFromAPs(x,y){
  if(!aps.length) return null;
  if(!scale.pxPerMeter){ alert('‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô (‡∏à‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö AP)'); throw new Error('no-scale'); }
  const P={x,y};
  let sum_mW = 0;
  for(const a of aps){
    const d_px = Math.hypot(x-a.x, y-a.y);
    const d_m = Math.max(1e-3, d_px / scale.pxPerMeter);
    const lossObs = pathObstacleLoss(P, a);
    const rssi = a.p0 - 10*a.n*Math.log10(d_m) - lossObs;
    sum_mW += Math.pow(10, rssi/10);
  }
  return 10 * Math.log10(Math.max(1e-15, sum_mW));
}

/* ========= Heatmap render (per-pixel + blur) ========= */
function renderHeatmap(){
  if(!floorImg){ alert('‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏õ‡∏•‡∏ô‡∏Å‡πà‡∏≠‡∏ô'); return; }
  if(aps.length===0){ alert('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ß‡∏≤‡∏á AP ‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡∏ï‡∏±‡∏ß'); return; }

  const alpha = clamp(parseFloat($('#alpha').value||'0.6'),0,1);
  const blurPx = Math.max(0, parseInt($('#blurPx').value||'16',10));

  UI.legendMin.textContent = RSSI_MIN;
  UI.legendMax.textContent = RSSI_MAX;
  makeFixedLegend();

  // 1) ‡∏ß‡∏≤‡∏î‡∏û‡∏∑‡πâ‡∏ô‡∏´‡∏•‡∏±‡∏á
  drawBase();

  // 2) ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏•‡∏á offscreen ‡πÅ‡∏ö‡∏ö "‡∏ï‡πà‡∏≠‡∏û‡∏¥‡∏Å‡πÄ‡∏ã‡∏•"
  const heat = document.createElement('canvas');
  heat.width = canvas.width; heat.height = canvas.height;
  const hctx = heat.getContext('2d', { willReadFrequently:true });
  let img = hctx.createImageData(heat.width, heat.height);
  let arr = img.data;

  for(let y=0; y<heat.height; y++){
    for(let x=0; x<heat.width; x++){
      const rssi = rssiFromAPs(x, y);
      const [r,g,b] = colorFromRSSI(rssi);
      const idx = (y*heat.width + x) * 4;
      arr[idx+0]=r; arr[idx+1]=g; arr[idx+2]=b; arr[idx+3]=255;
    }
  }
  hctx.putImageData(img, 0, 0);

  // 3) ‡∏ß‡∏≤‡∏á‡∏ã‡πâ‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢ blur + alpha
  ctx.save();
  ctx.globalAlpha = alpha;
  if(blurPx>0) ctx.filter = `blur(${blurPx}px)`;
  ctx.drawImage(heat, 0, 0);
  ctx.filter = 'none';
  ctx.restore();

  // 4) ‡∏ß‡∏≤‡∏î overlay
  drawOverlays();

  hasRendered = true;
}

/* ========= Probe (click to inspect) ========= */
function showProbeAt(xCanvas, yCanvas, rect){
  // ‡∏ß‡∏≤‡∏î‡∏ß‡∏á‡∏Å‡∏•‡∏°‡∏à‡∏∏‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏•‡∏¥‡∏Å (overlay)
  ctx.save();
  ctx.beginPath(); ctx.arc(xCanvas, yCanvas, 6, 0, Math.PI*2);
  ctx.fillStyle='#ffffff'; ctx.globalAlpha=.9; ctx.fill();
  ctx.lineWidth=2; ctx.strokeStyle='#000'; ctx.globalAlpha=1; ctx.stroke();
  ctx.restore();

  // ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì RSSI ‡πÅ‡∏•‡∏∞‡∏™‡∏µ
  const rssi = rssiFromAPs(xCanvas, yCanvas);
  const col = colorFromRSSI(rssi);
  const colStr = rgbStr(col);

  // ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï tooltip
  UI.probeVal.textContent = `${rssi.toFixed(1)} dBm`;
  UI.probeMeta.textContent = `x=${xCanvas|0}, y=${yCanvas|0}`;
  UI.probeSw.style.background = colStr;

  // ‡∏à‡∏±‡∏î‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á tooltip (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô stage)
  const stageRect = UI.stage.getBoundingClientRect();
  const px = (xCanvas / canvas.width)  * rect.width  + (rect.left - stageRect.left);
  const py = (yCanvas / canvas.height) * rect.height + (rect.top  - stageRect.top);

  UI.probe.style.left = `${px}px`;
  UI.probe.style.top  = `${py}px`;
  UI.probe.style.display = 'block';
}
function hideProbe(){ UI.probe.style.display='none'; }

/* ========= Lists & UI ========= */
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

function refreshAPList(){
  UI.apList.innerHTML = '';
  aps.forEach((a,i)=>{
    const row = document.createElement('div'); row.className='apRow small';
    row.innerHTML = `
      <div>
        <strong>${escapeHtml(a.label||'AP')}</strong> ¬∑ P0:${a.p0} dBm ¬∑ n:${a.n}
        <div class="muted">(${a.x|0},${a.y|0})</div>
      </div>
      <div class="row"><button data-i="${i}" class="danger" style="padding:4px 8px">‡∏•‡∏ö</button></div>`;
    row.querySelector('button').onclick = e=>{
      aps.splice(+e.target.getAttribute('data-i'),1);
      drawBase(); drawOverlays(); hideProbe(); refreshAPList();
    };
    UI.apList.appendChild(row);
  });
}

function refreshMatList(){
  UI.matList.innerHTML = '';
  segments.forEach((s,i)=>{
    const m = MATERIALS[s.type] || {name:s.type,color:'#fff'};
    const row = document.createElement('div'); row.className='matRow small';
    row.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px">
        <span class="dot" style="background:${m.color}"></span>
        <div>
          <div><strong>${m.name}</strong> ¬∑ ${s.att} dB</div>
          <div class="muted">A(${s.a.x|0},${s.a.y|0}) ‚Üí B(${s.b.x|0},${s.b.y|0})</div>
        </div>
      </div>
      <div class="row"><button data-i="${i}" class="danger" style="padding:4px 8px">‡∏•‡∏ö</button></div>`;
    row.querySelector('button').onclick = e=>{
      segments.splice(+e.target.getAttribute('data-i'),1);
      drawBase(); drawOverlays(); hideProbe(); refreshMatList();
    };
    UI.matList.appendChild(row);
  });
}

/* ========= Events ========= */
$('#fileInput').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const img = new Image();
  img.onload = ()=>{
    floorImg = document.createElement('canvas');
    floorImg.width = img.width; floorImg.height = img.height;
    const c = floorImg.getContext('2d'); c.drawImage(img,0,0);
    fitCanvasToImage(img);
    aps=[]; segments=[]; tempLine=null; scale.pxPerMeter=null; hasRendered=false;
    UI.scaleLabel.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á';
    drawBase(); drawOverlays(); makeFixedLegend(); hideProbe();
  };
  img.src = URL.createObjectURL(f);
});
$('#btnClear').onclick = ()=>{
  floorImg=null; aps=[]; segments=[]; tempLine=null; scale.pxPerMeter=null; hasRendered=false;
  UI.scaleLabel.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á'; drawBase(); drawOverlays(); makeFixedLegend(); hideProbe();
};

$('#btnScale').onclick = ()=>{ mode='scale'; hideProbe(); };
$('#btnAP').onclick    = ()=>{ mode='ap';    hideProbe(); };
$('#btnMat').onclick   = ()=>{ mode='mat';   hideProbe(); };

$('#btnAPUndo').onclick = ()=>{ aps.pop(); drawBase(); drawOverlays(); refreshAPList(); hideProbe(); };
$('#btnAPClear').onclick = ()=>{ if(confirm('‡∏•‡πâ‡∏≤‡∏á AP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ aps=[]; drawBase(); drawOverlays(); refreshAPList(); hideProbe(); } };

$('#btnMatUndo').onclick = ()=>{ segments.pop(); drawBase(); drawOverlays(); refreshMatList(); hideProbe(); };
$('#btnMatClear').onclick = ()=>{ if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ segments=[]; drawBase(); drawOverlays(); refreshMatList(); hideProbe(); } };

$('#btnRender').onclick = ()=>{ renderHeatmap(); hideProbe(); };
$('#btnExport').onclick = ()=>{ const a=document.createElement('a'); a.download='heatmap.png'; a.href=canvas.toDataURL('image/png'); a.click(); };

$('#btnSave').onclick = ()=>{
  const payload = {
    aps, segments,
    alpha: +($('#alpha').value||0.6),
    blurPx: +($('#blurPx').value||16),
    scale: scale.pxPerMeter
  };
  download('heatmap_project_planning_probe.json', JSON.stringify(payload,null,2));
};
$('#loadJson').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      aps      = obj.aps||[];
      segments = obj.segments||[];
      $('#alpha').value  = obj.alpha ?? 0.6;
      $('#blurPx').value = obj.blurPx ?? 16;
      scale.pxPerMeter = obj.scale || null;
      UI.scaleLabel.textContent = scale.pxPerMeter? `${(scale.pxPerMeter).toFixed(1)} px/‡πÄ‡∏°‡∏ï‡∏£`:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á';
      drawBase(); drawOverlays(); makeFixedLegend(); hideProbe();
    }catch(err){ alert('‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
  };
  reader.readAsText(f);
});

/* canvas interactions */
canvas.addEventListener('click', e=>{
  const {x,y,rect} = getCanvasPos(e);
  if(mode==='scale'){
    if(!tempLine) tempLine = {a:{x,y}, b:{x,y}};
    else{
      tempLine.b = {x,y};
      const Lpx = dist(tempLine.a,tempLine.b);
      const real = prompt(`‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏ï‡∏£) ‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${Lpx.toFixed(1)} px = ?`, '5');
      if(real && +real>0){
        scale.pxPerMeter = Lpx/(+real);
        UI.scaleLabel.textContent = `${scale.pxPerMeter.toFixed(1)} px/‡πÄ‡∏°‡∏ï‡∏£`;
      }
      tempLine=null; mode='idle'; drawBase(); drawOverlays(); hideProbe();
    }
  } else if(mode==='ap'){
    if(!scale.pxPerMeter){ alert('‡πÇ‡∏õ‡∏£‡∏î‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•‡∏Å‡πà‡∏≠‡∏ô‡∏ß‡∏≤‡∏á AP'); return; }
    const label = $('#apLabel').value.trim() || `AP-${aps.length+1}`;
    const p0 = parseFloat($('#apP0').value||'-40');
    const n  = parseFloat($('#apN').value||'2.2');
    aps.push({x,y,label,p0,n}); drawBase(); drawOverlays(); refreshAPList(); hideProbe();
  } else if(mode==='mat'){
    if(!tempLine) tempLine = {a:{x,y}, b:{x,y}};
    else{
      tempLine.b = {x,y};
      const type = $('#matType').value;
      const att = parseFloat($('#matAtt').value|| (MATERIALS[type]?.att||8));
      segments.push({a:{...tempLine.a}, b:{...tempLine.b}, type, att});
      tempLine=null; mode='idle'; drawBase(); drawOverlays(); refreshMatList(); hideProbe();
    }
  } else {
    // idle ‚Üí probe
    if(!hasRendered){ alert('‡πÇ‡∏õ‡∏£‡∏î‡∏Å‡∏î "‡∏™‡∏£‡πâ‡∏≤‡∏á Heatmap" ‡∏Å‡πà‡∏≠‡∏ô ‡πÅ‡∏•‡πâ‡∏ß‡∏Ñ‡πà‡∏≠‡∏¢‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏î‡∏π‡∏Ñ‡πà‡∏≤'); return; }
    // ‡∏ß‡∏≤‡∏î probe ‡πÉ‡∏´‡∏°‡πà (‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä‡∏û‡∏∑‡πâ‡∏ô-‡∏Æ‡∏µ‡∏ï‡πÅ‡∏°‡∏õ+overlay ‡∏Å‡πà‡∏≠‡∏ô ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏Ñ‡∏•‡∏µ‡∏¢‡∏£‡πå marker ‡πÄ‡∏Å‡πà‡∏≤)
    renderHeatmap();
    showProbeAt(x, y, rect);
  }
});

canvas.addEventListener('mousemove', ()=>{ /* reserved for future hover probe */ });

document.addEventListener('keydown', e=>{
  if(e.key==='s' || e.key==='S'){ mode='scale'; hideProbe(); }
  if(e.key==='a' || e.key==='A'){ mode='ap';    hideProbe(); }
  if(e.key==='w' || e.key==='W'){ mode='mat';   hideProbe(); }
  if(e.key==='h' || e.key==='H'){ renderHeatmap(); hideProbe(); }
});

/* ========= Init ========= */
(function init(){
  UI.legendMin.textContent = RSSI_MIN;
  UI.legendMax.textContent = RSSI_MAX;
  makeFixedLegend();
  drawBase(); drawOverlays(); hideProbe();
})();
</script>
</body>
</html>
