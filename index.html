<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wi-Fi Heatmap ‚Äî Fix Controls + Snap Walls</title>
<style>
  :root{ --bg:#0f1220; --panel:#171a2b; --muted:#9aa4b2; --text:#e8ecf1;
         --card:#1b2035; --btn:#232845; --ring:#2a7fff55; --danger:#ff7b7b; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(120deg,#0f1220,#0e1428 60%,#0f1220);
       color:var(--text);font:500 16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  header{padding:12px 16px;border-bottom:1px solid #202540;background:rgba(17,22,36,.7);
         position:sticky;top:0;backdrop-filter:blur(8px);z-index:50;display:flex;align-items:center;gap:10px}
  header h1{margin:0;font-size:18px;flex:1}
  .mode-switch{display:flex;gap:6px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a3156;background:#1a1f39;color:#cfd6ff;cursor:pointer}
  .pill.active{background:#2a3569;border-color:#3d4c9a;color:#fff;box-shadow:0 0 0 2px var(--ring)}
  .container{display:grid;grid-template-columns:380px 1fr;gap:14px;padding:14px;height:calc(100% - 56px)}
  .panel{background:var(--panel);border:1px solid #242a49;border-radius:14px;padding:14px;overflow:auto}
  .section{margin-bottom:14px;padding-bottom:12px;border-bottom:1px dashed #2a3156}
  .section:last-child{border-bottom:0;margin-bottom:0;padding-bottom:0}
  .label{font-size:13px;color:var(--muted);margin:6px 0 6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="file"],input[type="number"],input[type="text"],select,textarea{
    background:var(--card);border:1px solid #2a3156;color:var(--text);
    border-radius:10px;padding:8px 10px;outline:none
  }
  input[type="number"]{width:120px}
  input[type="range"]{width:180px}
  textarea{width:100%;min-height:54px;resize:vertical}
  button{
    background:var(--btn);border:1px solid #2a3156;color:var(--text);padding:9px 12px;border-radius:11px;
    cursor:pointer;transition:.15s;user-select:none
  }
  button:hover{transform:translateY(-1px);box-shadow:0 6px 18px -10px #000,0 0 0 2px var(--ring)}
  button.danger{background:#3a1b1b;border-color:#5a2a2a;color:#ffc6c6}
  .chip{font-size:12px;border:1px solid #2a3156;border-radius:999px;padding:4px 9px;color:#9aa4b2;display:inline-flex;gap:6px;align-items:center}
  .legend{display:flex;align-items:center;gap:10px}
  .grad{width:220px;height:12px;border-radius:999px;border:1px solid #2a3156}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .grid-1{display:grid;grid-template-columns:1fr;gap:8px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#222846;border:1px solid #2a3156;border-radius:6px;padding:2px 6px;color:#b9c3ff;font-size:12px}
  .muted{color:var(--muted)}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#22284a;border:1px solid #2a3156}
  .small{font-size:12px}
  .apRow,.matRow{display:flex;justify-content:space-between;gap:8px;align-items:center;background:#141a34;border:1px solid #2a3156;border-radius:10px;padding:6px 8px}
  .dot{width:10px;height:10px;border-radius:50%}
  details.spec>summary{cursor:pointer;padding:6px 10px;border:1px solid #2a3156;border-radius:8px;background:#1b2141}
  @media (max-width:980px){ .container{grid-template-columns:1fr} }
  .stage{position:relative;display:inline-block}
  #canvas,#overlay{display:block}
  #overlay{position:absolute; left:0; top:0; pointer-events:none; z-index:3;}
  #probe{position:absolute;display:none;transform:translate(10px,-10px);
         background:#0e1329;border:1px solid #2a3156;border-radius:10px;padding:6px 8px;
         color:#e8ecf1;font:600 13px ui-monospace,monospace;pointer-events:none;z-index:4;
         box-shadow:0 6px 20px rgba(0,0,0,.35)}
  #probe .sw{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;border:1px solid #0006}
  #probe .sub{font-weight:500;color:#9aa4b2;margin-top:2px}
</style>
</head>
<body>
<header>
  <h1>üì∂ Wi-Fi Heatmap</h1>
  <div class="mode-switch">
    <div class="pill active" id="pillPlanning">Planning</div>
    <div class="pill" id="pillSurvey">Survey</div>
  </div>
</header>

<div class="container" id="appPlanning" style="display:grid">
  <aside class="panel">
    <div class="section">
      <div class="label">1) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏õ‡∏•‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (PNG/JPG)</div>
      <div class="row"><input type="file" id="fileInput" accept="image/*"/><button id="btnClear">‡∏•‡πâ‡∏≤‡∏á</button></div>
      <div class="row" style="margin-top:8px">
        <div class="label">‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏ô (%)</div>
        <input type="range" id="imgScale" min="20" max="150" step="5" value="75"/>
        <input type="number" id="imgScaleNum" min="20" max="150" step="1" value="75" style="width:80px"/>
      </div>
    </div>

    <div class="section">
      <div class="label">2) ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á</div>
      <div class="row">
        <button id="btnScale">üß≠ ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•</button>
        <button id="btnIdle">üñ±Ô∏è ‡πÄ‡∏°‡πâ‡∏≤‡∏™‡πå‡∏õ‡∏Å‡∏ï‡∏¥</button>
        <span class="chip">‡∏™‡πÄ‡∏Å‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="scaleLabel">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á</span></span>
      </div>
      <div class="small muted">‡∏•‡∏≤‡∏Å‡πÑ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏ö‡∏ô‡πÅ‡∏õ‡∏•‡∏ô ‚Üí ‡πÉ‡∏™‡πà‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏ï‡∏£)</div>
    </div>

    <div class="section">
      <div class="label">3) ‡∏ß‡∏≤‡∏á Access Point (n ‡∏Ñ‡∏á‡∏ó‡∏µ‡πà‡∏ï‡∏≤‡∏°‡∏¢‡πà‡∏≤‡∏ô‡πÅ‡∏ö‡∏ö Ekahau)</div>
      <div class="grid" style="align-items:end">
        <div>
          <div class="label">‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï AP</div>
          <select id="apPreset"></select>
        </div>
        <div class="row"><button id="btnApplyPreset">‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏û‡∏£‡∏µ‡πÄ‡∏ã‡πá‡∏ï</button></div>
      </div>
      <div class="grid" style="margin-top:8px">
        <div><div class="label">‡∏ä‡∏∑‡πà‡∏≠/SSID</div><input type="text" id="apLabel" placeholder="‡πÄ‡∏ä‡πà‡∏ô AP-1"/></div>
        <div><div class="label">P‚ÇÄ @1 m (dBm)</div><input type="number" id="apP0" value="-40" step="1"/></div>
        <div><div class="label">‡∏¢‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</div>
          <select id="apBand"><option value="2.4">2.4 GHz</option><option value="5" selected>5 GHz</option></select>
        </div>
      </div>
      <details class="spec" style="margin-top:10px">
        <summary>üßæ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡πÄ‡∏õ‡∏Å AP</summary>
        <div class="grid-1" style="margin-top:8px">
          <div class="label">‡∏£‡∏∏‡πà‡∏ô</div><input type="text" id="apSpec_model" />
          <div class="label">‡∏õ‡∏∏‡πà‡∏°</div><textarea id="apSpec_buttons"></textarea>
          <div class="label">‡πÑ‡∏ü‡πÄ‡∏•‡∏µ‡πâ‡∏¢‡∏á</div><input type="text" id="apSpec_power" />
          <div class="label">‡πÄ‡∏™‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏®</div><input type="text" id="apSpec_ant" />
          <div class="label">‡∏û‡∏≠‡∏£‡πå‡∏ï</div><textarea id="apSpec_iface"></textarea>
          <div class="label">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà</div><textarea id="apSpec_standards"></textarea>
          <div class="label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</div><textarea id="apSpec_rate"></textarea>
          <div class="label">EIRP/RX</div><textarea id="apSpec_rf"></textarea>
          <div class="label">‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢</div><textarea id="apSpec_functions"></textarea>
          <div class="label">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á</div><input type="text" id="apSpec_cert" />
          <div class="label">‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏£‡∏∞‡∏ö‡∏ö</div><textarea id="apSpec_sysreq"></textarea>
          <div class="label">‡∏™‡∏†‡∏≤‡∏û‡πÅ‡∏ß‡∏î‡∏•‡πâ‡∏≠‡∏°</div><textarea id="apSpec_env"></textarea>
          <div class="label">‡πÇ‡∏ô‡πâ‡∏ï</div><textarea id="apSpec_notes"></textarea>
        </div>
      </details>
      <div class="row" style="margin-top:10px">
        <button id="btnAP">üì° ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏á AP</button>
        <button id="btnAPUndo" class="ghost">‚Ü©Ô∏è ‡∏•‡∏ö AP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        <button id="btnAPClear" class="danger">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á AP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
      <div id="apList" style="margin-top:10px;display:grid;gap:6px;"></div>
      <div class="small muted">n: 2.4GHz‚âà2.2 ‚Ä¢ 5GHz‚âà2.4</div>
    </div>

    <div class="section">
      <div class="label">4) ‡∏ß‡∏±‡∏™‡∏î‡∏∏/‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</div>
      <div class="grid">
        <div><div class="label">‡∏ä‡∏ô‡∏¥‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏</div><select id="matType"></select></div>
        <div><div class="label">‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏Å‡∏•‡∏∑‡∏ô (dB/‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div><input type="number" id="matAtt" value="8" step="0.5"/></div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnMat">üß± ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏</button>
        <button id="btnMatUndo" class="ghost">‚Ü©Ô∏è ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        <button id="btnMatClear" class="danger">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
      <div class="row" style="margin-top:8px">
        <label class="small"><input type="checkbox" id="snapEnabled" checked/> ‡∏™‡πÅ‡∏ô‡πá‡∏õ‡∏õ‡∏•‡∏≤‡∏¢‡πÄ‡∏™‡πâ‡∏ô‡πÉ‡∏´‡πâ‡∏ä‡∏ô‡∏Å‡∏±‡∏ô</label>
        <span class="small muted">‡∏£‡∏±‡∏®‡∏°‡∏µ (px)</span>
        <input type="number" id="snapRadius" value="12" min="4" max="40" step="1" style="width:70px"/>
      </div>
      <div id="matList" style="margin-top:10px;display:grid;gap:6px;"></div>
    </div>

    <div class="section">
      <div class="label">5) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
      <div class="grid">
        <div><div class="label">Blur (px)</div><input type="number" id="blurPx" value="16" min="0" step="1"/></div>
        <div><div class="label">‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™</div><input type="number" id="alpha" value="0.6" min="0" max="1" step="0.05"/></div>
        <div style="grid-column:1/-1"><label><input type="checkbox" id="showContours" checked/> ‡πÅ‡∏™‡∏î‡∏á‡∏Ñ‡∏≠‡∏ô‡∏ó‡∏±‡∏ß‡∏£‡πå‡∏ó‡∏∏‡∏Å ‚àí5 dBm (‚àí20..‚àí80)</label></div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnRender">üî• ‡∏™‡∏£‡πâ‡∏≤‡∏á Heatmap</button>
        <button id="btnExport">üñºÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PNG</button>
      </div>
      <div class="legend" style="margin-top:10px">
        <div id="grad" class="grad"></div>
        <div class="small">‡∏™‡∏µ: ‚â§‚àí67=‡πÄ‡∏ó‡∏≤ (‡∏à‡∏≤‡∏á‡∏•‡∏á‡∏ñ‡∏∂‡∏á ‚àí80), ‚àí60=‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á, ‚àí30=‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß</div>
      </div>
    </div>

    <div class="section">
      <div class="label">6) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå</div>
      <div class="row">
        <button id="btnSave">üíæ Save JSON</button>
        <input type="file" id="loadJson" accept="application/json"/>
      </div>
    </div>

    <div class="section small muted">
      ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î: <span class="kbd">S</span> ‡∏™‡πÄ‡∏Å‡∏• ‚Ä¢ <span class="kbd">A</span> ‡∏ß‡∏≤‡∏á AP ‚Ä¢ <span class="kbd">W</span> ‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‚Ä¢ <span class="kbd">H</span> ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Ä¢ <span class="kbd">Esc</span> ‡πÄ‡∏°‡πâ‡∏≤‡∏™‡πå‡∏õ‡∏Å‡∏ï‡∏¥
    </div>
  </aside>

  <main class="panel">
    <div class="row">
      <span class="badge" id="modeBadge">‡πÇ‡∏´‡∏°‡∏î: Idle (‡πÄ‡∏°‡πâ‡∏≤‡∏™‡πå‡∏õ‡∏Å‡∏ï‡∏¥)</span>
      <span class="muted small">‡∏™‡πÄ‡∏Å‡∏•/‡∏ß‡∏±‡∏™‡∏î‡∏∏ = ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‚Äì‡∏•‡∏≤‡∏Å‚Äì‡∏õ‡∏•‡πà‡∏≠‡∏¢ | AP = ‡∏Ñ‡∏•‡∏¥‡∏Å | Probe = ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå</span>
    </div>
    <div class="stage" id="stage">
      <canvas id="canvas" width="1280" height="800"></canvas>
      <canvas id="overlay" width="1280" height="800"></canvas>
      <div id="probe">
        <div><span class="sw" id="sw"></span><span id="probeVal">‚Äì dBm</span></div>
        <div class="sub" id="probeMeta"></div>
      </div>
    </div>
  </main>
</div>

<div class="container" id="appSurvey" style="display:none;grid-template-columns:1fr">
  <main class="panel">
    <div class="row"><span class="badge">‡πÇ‡∏´‡∏°‡∏î: Survey (Placeholder)</span><span class="muted small">‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡πà‡∏≠‡πÑ‡∏î‡πâ</span></div>
    <div style="background:#fff;border:1px dashed #ccc;border-radius:12px;min-height:300px;display:flex;align-items:center;justify-content:center;color:#333;font:600 18px/1.3 ui-sans-serif">Survey Mode ‚Äî Blank</div>
  </main>
</div>

<script>
/* ===== Presets ===== */
const AP_PRESETS={
  tplink_ax20:{name:"TP-Link Archer AX20 (AX1800)",defaults:{p0:-40,band:'5'},
    spec:{model:"Archer AX20",buttons:"Reset,WPS/Wi-Fi,Power,LED On/Off",
      power:"12V 1.5A",antenna:"4√ó Fixed (beamforming)",iface:"1√óGb WAN,4√óGb LAN",
      standards:"802.11ax/ac/n/a (5G), 802.11ax/n/b/g (2.4G)",
      rate:"AX1800 ‚Äî 5G 1201 Mbps; 2.4G 574 Mbps",rf:"‚Äî",functions:"SPI FW, ACL, IP/MAC Binding",
      cert:"FCC/CE/RoHS",sysreq:"IE11+/FF12+/Chrome20+/Safari4+",env:"Op 0‚Äì40¬∞C; St ‚àí40‚Äì70¬∞C; RH 10‚Äì90/5‚Äì90%",notes:"260.2√ó135√ó38.6mm"}},
  totolink_a3002ru:{name:"TOTOLINK A3002RU (AC1200)",defaults:{p0:-42,band:'5'},
    spec:{model:"A3002RU",buttons:"RST,WPS,Power",power:"12V 2A",
      antenna:"2√ó5dBi(2.4G)+2√ó5dBi(5G)",iface:"4√óGb LAN,1√óGb WAN,1√óUSB2.0",
      standards:"802.11ac/n/g/b/a Dual-Band",
      rate:"2.4G up to 300; 5G up to 867 Mbps",
      rf:"EIRP 2.4G<20 dBm; 5G<23 dBm; RX sens refs",
      functions:"Router/Bridge/Repeater/WISP, WEP/WPA/WPA2, QoS, TR-069, DDNS, SNMP",
      cert:"‚Äî",sysreq:"‚Äî",env:"‚Äî",notes:"LEDs: Power,CPU,2.4G,5G,WAN,4√óLAN,USB"}}
};

/* ===== Modes & UI ===== */
let appMode='planning';
const appPlanning=document.getElementById('appPlanning');
const appSurvey=document.getElementById('appSurvey');
const pillPlanning=document.getElementById('pillPlanning');
const pillSurvey=document.getElementById('pillSurvey');
function setApp(m){appMode=m;
  if(m==='planning'){appPlanning.style.display='grid';appSurvey.style.display='none';pillPlanning.classList.add('active');pillSurvey.classList.remove('active');}
  else{appPlanning.style.display='none';appSurvey.style.display='grid';pillPlanning.classList.remove('active');pillSurvey.classList.add('active');}}
pillPlanning.onclick=()=>setApp('planning');
pillSurvey.onclick=()=>setApp('survey');

const RSSI_MIN=-80, P_GRAY=-67, P_YELLOW=-60, P_GREEN=-30;
const N_BY_BAND={'2.4':2.2,'5':2.4};
const GRAY_BASE=[128,128,128], GRAY_LIGHT=[220,220,220];
const CONTOUR_LEVELS=[-20,-25,-30,-35,-40,-45,-50,-55,-60,-65,-70,-75,-80];
const CONTOUR_STEP=2;
const $=s=>document.querySelector(s);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const lerp=(a,b,t)=>a+(b-a)*t;
const mix=(c1,c2,t)=>[Math.round(lerp(c1[0],c2[0],t)),Math.round(lerp(c1[1],c2[1],t)),Math.round(lerp(c1[2],c2[2],t))];
const rgbStr=([r,g,b])=>`rgb(${r},${g},${b})`;
const clamp01=v=>Math.max(0,Math.min(1,v));

/* ===== Canvas & state ===== */
const canvas=$('#canvas'), ctx=canvas.getContext('2d',{willReadFrequently:true});
const overlay=$('#overlay'), octx=overlay.getContext('2d',{willReadFrequently:true});
let floorImg=null, floorScale=0.75;
let aps=[], segments=[];
let mode='idle', dragging=false, dragStart=null;
let scale={pxPerMeter:null, refW:null};
let hasRendered=false;

const UI={
  modeBadge:$('#modeBadge'), scaleLabel:$('#scaleLabel'),
  apList:$('#apList'), matList:$('#matList'),
  probe:$('#probe'), probeVal:$('#probeVal'), probeMeta:$('#probeMeta'), probeSw:$('#sw'),
  stage:$('#stage'),
  imgScale:$('#imgScale'), imgScaleNum:$('#imgScaleNum'),
  apPreset:$('#apPreset'), apBand:$('#apBand')
};

/* ===== Fill preset options ===== */
(function(){ for(const k of Object.keys(AP_PRESETS)){ const o=document.createElement('option'); o.value=k; o.textContent=AP_PRESETS[k].name; UI.apPreset.appendChild(o);} })();

/* ===== Materials ===== */
const MATERIALS={
  drywall:{name:'‡∏ú‡∏ô‡∏±‡∏á‡∏¢‡∏¥‡∏õ‡∏ã‡∏±‡∏° (Drywall)',color:'#98c1ff',att:3},
  glass:{name:'‡∏Å‡∏£‡∏∞‡∏à‡∏Å',color:'#7de1ff',att:4},
  wood:{name:'‡πÑ‡∏°‡πâ',color:'#9ae27b',att:5},
  brick:{name:'‡∏≠‡∏¥‡∏ê/‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡∏°‡∏ß‡∏•‡πÄ‡∏ö‡∏≤',color:'#ffb673',att:8},
  concrete:{name:'‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏´‡∏•‡πá‡∏Å',color:'#ff8f8f',att:12},
  metal:{name:'‡πÇ‡∏•‡∏´‡∏∞‡πÅ‡∏ú‡πà‡∏ô/‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÄ‡∏´‡∏•‡πá‡∏Å',color:'#ffd36a',att:20},
  human:{name:'‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏Ñ‡∏ô (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)',color:'#d6b3ff',att:3}
};
const matTypeSel=$('#matType');
Object.keys(MATERIALS).forEach(k=>{ const o=document.createElement('option'); o.value=k; o.textContent=MATERIALS[k].name; matTypeSel.appendChild(o); });
matTypeSel.value='brick'; $('#matAtt').value=MATERIALS['brick'].att;
matTypeSel.addEventListener('change',()=>$('#matAtt').value=MATERIALS[matTypeSel.value].att);

/* ===== Coordinate helpers ===== */
function getImageRect(){ const w=Math.round(canvas.width*floorScale), h=Math.round(canvas.height*floorScale);
  const x=Math.round((canvas.width-w)/2), y=Math.round((canvas.height-h)/2); return {x,y,w,h}; }
function screenToWorld(pt){ const r=getImageRect(); return { nx:(pt.x-r.x)/r.w, ny:(pt.y-r.y)/r.h }; }
function worldToScreen(npt){ const r=getImageRect(); return { x:r.x+npt.nx*r.w, y:r.y+npt.ny*r.h }; }
function currentPxPerMeter(){ if(!scale.pxPerMeter) return null; const r=getImageRect(); const k=scale.refW?(r.w/scale.refW):1; return scale.pxPerMeter*k; }

/* ===== Mode & drawing ===== */
function setMode(m){ mode=m;
  UI.modeBadge.textContent = m==='ap'?'‡πÇ‡∏´‡∏°‡∏î: ‡∏ß‡∏≤‡∏á AP (‡∏Ñ‡∏•‡∏¥‡∏Å)': m==='mat'?'‡πÇ‡∏´‡∏°‡∏î: ‡∏ß‡∏±‡∏™‡∏î‡∏∏ (‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô)': m==='scale'?'‡πÇ‡∏´‡∏°‡∏î: ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•':'‡πÇ‡∏´‡∏°‡∏î: Idle (‡πÄ‡∏°‡πâ‡∏≤‡∏™‡πå‡∏õ‡∏Å‡∏ï‡∏¥)';
  canvas.style.cursor=(m==='ap'||m==='mat'||m==='scale')?'crosshair':'default'; hideProbe(); }

function applyCanvasCSSSize(){ canvas.style.width=canvas.width+'px'; canvas.style.height=canvas.height+'px';
  overlay.style.width=canvas.width+'px'; overlay.style.height=canvas.height+'px'; overlay.style.left='0px'; overlay.style.top='0px';}
function fitCanvasToImage(img){ const maxW=1920,maxH=1080,k=Math.min(maxW/img.width,maxH/img.height,1);
  canvas.width=Math.round(img.width*k); canvas.height=Math.round(img.height*k); overlay.width=canvas.width; overlay.height=canvas.height; applyCanvasCSSSize(); }
window.addEventListener('resize', applyCanvasCSSSize);

function drawBase(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(floorImg){ const r=getImageRect(); ctx.drawImage(floorImg,0,0,floorImg.width,floorImg.height,r.x,r.y,r.w,r.h); }
  else{ ctx.fillStyle='#0c1022'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle='#1c264a'; ctx.lineWidth=1;
    for(let x=0;x<canvas.width;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke()}
    for(let y=0;y<canvas.height;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke()} }
  hideProbe();
}
function drawPermanent(){
  ctx.lineWidth=3;
  // materials
  segments.forEach(s=>{ const m=MATERIALS[s.type]||{color:'#fff'}; const A=worldToScreen(s.aN), B=worldToScreen(s.bN);
    ctx.strokeStyle=m.color; ctx.beginPath(); ctx.moveTo(A.x,A.y); ctx.lineTo(B.x,B.y); ctx.stroke(); });
  // APs
  aps.forEach(a=>{ const P=worldToScreen({nx:a.nx,ny:a.ny});
    ctx.fillStyle='#8fd3ff'; ctx.beginPath(); ctx.arc(P.x,P.y,7,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#2a7fff'; ctx.lineWidth=2; ctx.stroke();
    ctx.fillStyle='#cfe6ff'; ctx.font='12px ui-monospace,monospace';
    const model=a.spec?.model?` (${a.spec.model})`:''; ctx.fillText(`${a.label||'AP'}${model} ¬∑ P0:${a.p0} ¬∑ ${a.band}GHz`, P.x+10, P.y-8);
  });
}

/* Overlay */
function clearOverlay(){ octx.clearRect(0,0,overlay.width,overlay.height); }
function drawArrow(a,b,{color='#6ae3ff',width=3.5,head=12,dash=[10,6],label=''}={}){
  octx.save(); octx.lineWidth=width; octx.setLineDash(dash); octx.strokeStyle=color;
  octx.beginPath(); octx.moveTo(a.x,a.y); octx.lineTo(b.x,b.y); octx.stroke(); octx.setLineDash([]);
  const ang=Math.atan2(b.y-a.y,b.x-a.x);
  octx.beginPath(); octx.moveTo(b.x,b.y);
  octx.lineTo(b.x-head*Math.cos(ang-Math.PI/7), b.y-head*Math.sin(ang-Math.PI/7));
  octx.lineTo(b.x-head*Math.cos(ang+Math.PI/7), b.y-head*Math.sin(ang+Math.PI/7));
  octx.closePath(); octx.fillStyle=color; octx.fill();
  octx.fillStyle='#fff'; octx.strokeStyle='#000'; octx.lineWidth=2;
  [a,b].forEach(p=>{ octx.beginPath(); octx.arc(p.x,p.y,4,0,Math.PI*2); octx.fill(); octx.stroke(); });
  if(label){ octx.font='12px ui-monospace,monospace'; octx.fillStyle='#cfe6ff'; octx.fillText(label,b.x+10,b.y-8); }
  octx.restore();
}

/* Legend & colormap */
function makeFixedLegend(){ const g=$('#grad'); const cvs=document.createElement('canvas'); cvs.width=256; cvs.height=1;
  const c=cvs.getContext('2d'); const span1=P_GRAY-RSSI_MIN, span2=P_YELLOW-P_GRAY, span3=P_GREEN-P_YELLOW;
  const usable=240, s=usable/(span1+span2+span3); const px1=Math.round(span1*s), px2=Math.round(span2*s), px3=Math.round(span3*s), pxG=256-(px1+px2+px3);
  let x=0; for(let i=0;i<px1;i++,x++){ const t=i/(px1||1), col=mix(GRAY_LIGHT,GRAY_BASE,t); c.fillStyle=rgbStr(col); c.fillRect(x,0,1,1); }
  for(let i=0;i<px2;i++,x++){ const t=i/(px2||1), col=mix(GRAY_BASE,[255,255,0],t); c.fillStyle=rgbStr(col); c.fillRect(x,0,1,1); }
  for(let i=0;i<px3;i++,x++){ const t=i/(px3||1), col=mix([255,255,0],[0,255,0],t); c.fillStyle=rgbStr(col); c.fillRect(x,0,1,1); }
  c.fillStyle='rgb(0,255,0)'; c.fillRect(x,0,pxG,1); g.style.backgroundImage=`url(${cvs.toDataURL()})`; }
function colorFromRSSI(v){
  if(v<=P_GRAY){ const t=clamp((P_GRAY-v)/(P_GRAY-RSSI_MIN),0,1); return mix(GRAY_BASE,GRAY_LIGHT,t);}
  if(v<=P_YELLOW){ const t=(v-P_GRAY)/(P_YELLOW-P_GRAY); return mix(GRAY_BASE,[255,255,0],t);}
  if(v<=P_GREEN){ const t=(v-P_YELLOW)/(P_GREEN-P_YELLOW); return mix([255,255,0],[0,255,0],t);}
  return [0,255,0];
}

/* Geometry & loss */
function orient(a,b,c){ return (b.x-a.x)*(c.y-a.y)-(b.y-a.y)*(c.x-a.x); }
function onSeg(a,b,c){ return Math.min(a.x,b.x)-1e-6<=c.x&&c.x<=Math.max(a.x,b.x)+1e-6 && Math.min(a.y,b.y)-1e-6<=c.y&&c.y<=Math.max(a.y,b.y)+1e-6; }
function segIntersect(p1,p2,q1,q2){
  const o1=orient(p1,p2,q1),o2=orient(p1,p2,q2),o3=orient(q1,q2,p1),o4=orient(q1,q2,p2);
  if((o1*o2<0)&&(o3*o4<0)) return true;
  if(Math.abs(o1)<1e-8&&onSeg(p1,p2,q1)) return true;
  if(Math.abs(o2)<1e-8&&onSeg(p1,p2,q2)) return true;
  if(Math.abs(o3)<1e-8&&onSeg(q1,q2,p1)) return true;
  if(Math.abs(o4)<1e-8&&onSeg(q1,q2,p2)) return true;
  return false;
}
function pathObstacleLossAlong(P,Ap,segList){ let loss=0; for(const s of segList){ if(segIntersect(P,Ap,s.a,s.b)) loss+= (+s.att||0); } return loss; }

/* RSSI */
function rssiFromAPs(x,y){
  if(!aps.length) return RSSI_MIN;
  const pxPerM=currentPxPerMeter(); if(!pxPerM) return RSSI_MIN;
  const P={x,y}; const segScreen=segments.map(s=>({a:worldToScreen(s.aN), b:worldToScreen(s.bN), att:s.att}));
  let sum_mW=0;
  for(const a of aps){
    const Ap=worldToScreen({nx:a.nx,ny:a.ny});
    const d_px=Math.hypot(x-Ap.x,y-Ap.y); const d_m=Math.max(1e-3,d_px/pxPerM);
    const loss=pathObstacleLossAlong(P,Ap,segScreen); const nEff=N_BY_BAND[a.band]??2.3;
    const rssi=a.p0 - 10*nEff*Math.log10(d_m) - loss; sum_mW += Math.pow(10, rssi/10);
  }
  return 10*Math.log10(Math.max(1e-15,sum_mW));
}

/* Marching squares contours */
function drawContours(field,w,h,levels,step=2){
  if(!$('#showContours').checked) return;
  ctx.save(); ctx.strokeStyle='#fff'; ctx.lineWidth=1.4; ctx.lineJoin='round'; ctx.lineCap='round'; ctx.globalAlpha=.98;
  const nx=Math.floor((w-1)/step), ny=Math.floor((h-1)/step);
  for(const L of levels){
    for(let gy=0;gy<ny;gy++){
      const y0=gy*step,y1=y0+step;
      for(let gx=0;gx<nx;gx++){
        const x0=gx*step,x1=x0+step;
        const i00=y0*w+x0,i10=y0*w+x1,i11=y1*w+x1,i01=y1*w+x0;
        const v00=field[i00],v10=field[i10],v11=field[i11],v01=field[i01];
        const b0=v00>=L?1:0,b1=v10>=L?1:0,b2=v11>=L?1:0,b3=v01>=L?1:0;
        const code=(b0)|(b1<<1)|(b2<<2)|(b3<<3); if(code===0||code===15) continue;
        const interp=(xa,ya,xb,yb,va,vb)=>{ const t=(L-va)/((vb-va)||1e-9); return [xa+(xb-xa)*t, ya+(yb-ya)*t]; };
        const T=interp(x0,y0,x1,y0,v00,v10), R=interp(x1,y0,x1,y1,v10,v11),
              B=interp(x0,y1,x1,y1,v01,v11), Lp=interp(x0,y0,x0,y1,v00,v01);
        const seg=(p,q)=>{ ctx.beginPath(); ctx.moveTo(p[0],p[1]); ctx.lineTo(q[0],q[1]); ctx.stroke(); };
        switch(code){
          case 1: case 14: seg(Lp,T); break;
          case 2: case 13: seg(T,R); break;
          case 3: case 12: seg(Lp,R); break;
          case 4: case 11: seg(R,B); break;
          case 5:           seg(Lp,T); seg(R,B); break;
          case 6: case 9 : seg(T,B); break;
          case 7: case 8 : seg(Lp,B); break;
          case 10:          seg(T,R); seg(Lp,B); break;
        }
      }
    }
  }
  ctx.restore();
}

/* Render */
function renderHeatmap(){
  if(aps.length===0) return; // ‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏π‡∏õ‡πÅ‡∏õ‡∏•‡∏ô
  makeFixedLegend(); drawBase();

  const heat=document.createElement('canvas'); heat.width=canvas.width; heat.height=canvas.height;
  const hctx=heat.getContext('2d',{willReadFrequently:true});
  const img=hctx.createImageData(heat.width,heat.height), arr=img.data;
  const field=new Float32Array(heat.width*heat.height);

  for(let y=0;y<heat.height;y++){
    for(let x=0;x<heat.width;x++){
      const rssi=rssiFromAPs(x,y); field[y*heat.width+x]=rssi;
      const [r,g,b]=colorFromRSSI(rssi);
      const i=(y*heat.width+x)*4; arr[i]=r; arr[i+1]=g; arr[i+2]=b; arr[i+3]=255;
    }
  }
  hctx.putImageData(img,0,0);

  const alpha=clamp(parseFloat($('#alpha').value||'0.6'),0,1);
  const blurPx=Math.max(0,parseInt($('#blurPx').value||'16',10));
  ctx.save(); ctx.globalAlpha=alpha; if(blurPx>0) ctx.filter=`blur(${blurPx}px)`; ctx.drawImage(heat,0,0); ctx.filter='none'; ctx.restore();

  drawPermanent();
  ctx.save(); drawContours(field, heat.width, heat.height, CONTOUR_LEVELS, CONTOUR_STEP); ctx.restore();

  hasRendered=true;
}

/* Probe */
function showProbeAt(x,y){
  ctx.save(); ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.globalAlpha=.9; ctx.fill();
  ctx.lineWidth=2; ctx.strokeStyle='#000'; ctx.globalAlpha=1; ctx.stroke(); ctx.restore();
  const rssi=rssiFromAPs(x,y), col=colorFromRSSI(rssi);
  UI.probeVal.textContent=`${rssi.toFixed(1)} dBm`; UI.probeMeta.textContent=`x=${x|0}, y=${y|0}`; UI.probeSw.style.background=rgbStr(col);
  const stageRect=UI.stage.getBoundingClientRect(); const cRect=canvas.getBoundingClientRect();
  const px=(x/canvas.width)*cRect.width+(cRect.left-stageRect.left), py=(y/canvas.height)*cRect.height+(cRect.top-stageRect.top);
  UI.probe.style.left=`${px}px`; UI.probe.style.top=`${py}px`; UI.probe.style.display='block';
}
function hideProbe(){ UI.probe.style.display='none'; }

/* Lists */
function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function refreshAPList(){
  UI.apList.innerHTML='';
  aps.forEach((a,i)=>{ const P=worldToScreen({nx:a.nx,ny:a.ny});
    const row=document.createElement('div'); row.className='apRow small';
    const model=a.spec?.model?` (${escapeHtml(a.spec.model)})`:'';
    row.innerHTML=`<div><strong>${escapeHtml(a.label||'AP')}${model}</strong> ¬∑ P0:${a.p0} dBm ¬∑ ${a.band}GHz
      <div class="muted">(${P.x|0},${P.y|0})</div></div>
      <div class="row"><button class="ghost" data-i="${i}" style="padding:4px 8px">‚ÑπÔ∏è</button>
      <button class="danger" data-del="${i}" style="padding:4px 8px">‡∏•‡∏ö</button></div>`;
    row.querySelector('button.ghost').onclick=e=>{
      const spec=aps[+e.target.getAttribute('data-i')]?.spec||{}; const lines=[];
      for(const [k,v] of Object.entries(spec)){ if(v) lines.push(`${k}: ${v}`); }
      alert(lines.join('\n')||'(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÄ‡∏õ‡∏Å)');
    };
    row.querySelector('button[data-del]').onclick=e=>{
      aps.splice(+e.target.getAttribute('data-del'),1);
      drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshAPList();
    };
    UI.apList.appendChild(row);
  });
}
function refreshMatList(){
  UI.matList.innerHTML='';
  segments.forEach((s,i)=>{ const m=MATERIALS[s.type]||{name:s.type,color:'#fff'}; const A=worldToScreen(s.aN), B=worldToScreen(s.bN);
    const row=document.createElement('div'); row.className='matRow small';
    row.innerHTML=`<div style="display:flex;align-items:center;gap:8px">
        <span class="dot" style="background:${m.color}"></span>
        <div><div><strong>${m.name}</strong> ¬∑ ${s.att} dB</div>
        <div class="muted">A(${A.x|0},${A.y|0}) ‚Üí B(${B.x|0},${B.y|0})</div></div>
      </div>
      <div class="row"><button data-i="${i}" class="danger" style="padding:4px 8px">‡∏•‡∏ö</button></div>`;
    row.querySelector('button').onclick=e=>{
      segments.splice(+e.target.getAttribute('data-i'),1);
      drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshMatList();
    };
    UI.matList.appendChild(row);
  });
}

/* Save/Load */
$('#btnSave').onclick=()=>{ const payload={aps,segments,alpha:+($('#alpha').value||0.6),blurPx:+($('#blurPx').value||16),scale,floorScale,showContours:$('#showContours').checked};
  const a=document.createElement('a'); a.href=URL.createObjectURL(new Blob([JSON.stringify(payload,null,2)],{type:"application/json"}));
  a.download='heatmap_project_planning.json'; a.click(); URL.revokeObjectURL(a.href); };
$('#loadJson').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return; const reader=new FileReader();
  reader.onload=()=>{ try{
    let obj=JSON.parse(reader.result); aps=obj.aps||[]; segments=obj.segments||[];
    // migrate to normalized
    const r=getImageRect();
    aps=aps.map(a=>('nx' in a&&'ny' in a)?a:{...a,nx:clamp01((a.x-r.x)/r.w),ny:clamp01((a.y-r.y)/r.h)});
    segments=segments.map(s=>s.aN&&s.bN?s:{...s,aN:{nx:clamp01((s.a.x-r.x)/r.w),ny:clamp01((s.a.y-r.y)/r.h)},bN:{nx:clamp01((s.b.x-r.x)/r.w),ny:clamp01((s.b.y-r.y)/r.h)}});
    $('#alpha').value=obj.alpha??0.6; $('#blurPx').value=obj.blurPx??16;
    scale={pxPerMeter: obj.scale?.pxPerMeter ?? obj.scale ?? null, refW: obj.scale?.refW ?? null};
    floorScale=clamp(obj.floorScale ?? floorScale,0.2,1.5); if(typeof obj.showContours==='boolean') $('#showContours').checked=obj.showContours;
    UI.imgScale.value=Math.round(floorScale*100); UI.imgScaleNum.value=Math.round(floorScale*100);
    UI.scaleLabel.textContent=scale.pxPerMeter?`${(scale.pxPerMeter).toFixed(1)} px/‡πÄ‡∏°‡∏ï‡∏£`:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á';
    drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshAPList(); refreshMatList();
  }catch(err){ console.error(err); } }; reader.readAsText(f);
});

/* Image I/O */
$('#fileInput').addEventListener('change', e=>{ const f=e.target.files[0]; if(!f) return;
  const img=new Image(); img.onload=()=>{ floorImg=img; fitCanvasToImage(img); drawBase(); drawPermanent(); };
  img.src=URL.createObjectURL(f); });
$('#btnClear').onclick=()=>{ floorImg=null; drawBase(); drawPermanent(); };

/* Snap helpers */
function getSnapRadius(){ const v=parseInt($('#snapRadius')?.value||'12',10); return isNaN(v)?12:v; }
function collectMaterialNodesScreen(){ const nodes=[]; for(const s of segments){ const A=worldToScreen(s.aN), B=worldToScreen(s.bN);
  nodes.push({x:A.x,y:A.y,n:s.aN}); nodes.push({x:B.x,y:B.y,n:s.bN}); } return nodes; }
function findSnapTargetScreen(pt){ if(!$('#snapEnabled')?.checked) return null; const R=getSnapRadius(), nodes=collectMaterialNodesScreen();
  let best=null,bd=Infinity; for(const nd of nodes){ const d=Math.hypot(pt.x-nd.x,pt.y-nd.y); if(d<=R && d<bd){bd=d; best=nd;} } return best; }
function trySnapNormalized(npt){ const p=worldToScreen(npt); const hit=findSnapTargetScreen(p); return hit?hit.n:npt; }
function drawSnapHint(pt){ const hit=findSnapTargetScreen(pt); if(!hit) return; octx.save(); octx.beginPath(); octx.arc(hit.x,hit.y,6,0,Math.PI*2);
  octx.lineWidth=2; octx.strokeStyle='#fff'; octx.fillStyle='#0008'; octx.fill(); octx.stroke(); octx.restore(); }

/* Drag */
function getCanvasPos(e){ const rect=canvas.getBoundingClientRect(); const sx=canvas.width/rect.width, sy=canvas.height/rect.height;
  return { x:(e.clientX-rect.left)*sx, y:(e.clientY-rect.top)*sy, rect }; }
function startDrag(x,y){ dragging=true; if(mode==='mat'){ const hit=findSnapTargetScreen({x,y}); if(hit){x=hit.x;y=hit.y;} } dragStart={x,y}; clearOverlay(); }
function updateDrag(x,y){
  if(!dragging||!dragStart) return; clearOverlay();
  if(mode==='scale'||mode==='mat'){
    let A={x:dragStart.x,y:dragStart.y}, B={x,y};
    if(mode==='mat'){ const h1=findSnapTargetScreen(A), h2=findSnapTargetScreen(B); if(h1) A={x:h1.x,y:h1.y}; if(h2) B={x:h2.x,y:h2.y}; drawSnapHint(A); drawSnapHint(B); }
    const label=(mode==='scale')?`${dist(dragStart,{x,y}).toFixed(1)} px`:`${MATERIALS[$('#matType').value]?.name||'‡∏ß‡∏±‡∏™‡∏î‡∏∏'} ¬∑ ${($('#matAtt').value||'0')} dB`;
    const color=(mode==='scale')?'#6ae3ff':'#ffd36a'; drawArrow(A,B,{color,width:3.5,head:12,dash:[10,6],label});
  }
}
function endDrag(x,y){
  if(!dragging||!dragStart) return; clearOverlay();
  const a={...dragStart}, b={x,y};
  if(mode==='scale'){
    const Lpx=dist(a,b); const real=prompt(`‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏ï‡∏£) = ?  (‡πÑ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î‡∏¢‡∏≤‡∏ß ${Lpx.toFixed(1)} px)`, '5');
    if(real && +real>0){ scale.pxPerMeter=Lpx/(+real); scale.refW=getImageRect().w; UI.scaleLabel.textContent=`${scale.pxPerMeter.toFixed(1)} px/‡πÄ‡∏°‡∏ï‡∏£`; }
    setMode('idle'); drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent();
  }else if(mode==='mat'){
    const type=$('#matType').value, att=parseFloat($('#matAtt').value||(MATERIALS[type]?.att||8));
    const na=trySnapNormalized(screenToWorld(a)), nb=trySnapNormalized(screenToWorld(b));
    segments.push({aN:{nx:clamp01(na.nx),ny:clamp01(na.ny)}, bN:{nx:clamp01(nb.nx),ny:clamp01(nb.ny)}, type, att});
    setMode('idle'); drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshMatList();
  }
  dragging=false; dragStart=null;
}
canvas.addEventListener('mousedown', e=>{ if(appMode!=='planning') return; const {x,y}=getCanvasPos(e); if(mode==='scale'||mode==='mat') startDrag(x,y); });
canvas.addEventListener('mousemove', e=>{ if(appMode!=='planning') return; const {x,y}=getCanvasPos(e); if(mode==='scale'||mode==='mat') updateDrag(x,y); });
canvas.addEventListener('mouseup',   e=>{ if(appMode!=='planning') return; const {x,y}=getCanvasPos(e); if(mode==='scale'||mode==='mat') endDrag(x,y); });
canvas.addEventListener('mouseleave',()=>{ if(appMode!=='planning') return; dragging=false; dragStart=null; clearOverlay(); });

/* Clicks: AP / Probe */
canvas.addEventListener('click', e=>{
  if(appMode!=='planning') return; const {x,y}=getCanvasPos(e);
  if(mode==='ap'){
    if(!scale.pxPerMeter){ scale.pxPerMeter=100; scale.refW=getImageRect().w; UI.scaleLabel.textContent=`${scale.pxPerMeter.toFixed(1)} px/‡πÄ‡∏°‡∏ï‡∏£ (‡∏ï‡∏±‡πâ‡∏á‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥)`; }
    const label=$('#apLabel').value.trim()||`AP-${aps.length+1}`, p0=parseFloat($('#apP0').value||'-40'), band=$('#apBand').value==='2.4'?'2.4':'5';
    const n=screenToWorld({x,y}); const g=id=>document.getElementById(id).value.trim();
    const spec={model:g('apSpec_model'),buttons:g('apSpec_buttons'),power:g('apSpec_power'),antenna:g('apSpec_ant'),
      iface:g('apSpec_iface'),standards:g('apSpec_standards'),rate:g('apSpec_rate'),rf:g('apSpec_rf'),
      functions:g('apSpec_functions'),cert:g('apSpec_cert'),sysreq:g('apSpec_sysreq'),env:g('apSpec_env'),notes:g('apSpec_notes')};
    aps.push({nx:clamp01(n.nx),ny:clamp01(n.ny),label,p0,band,spec});
    drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshAPList();
  }else if(mode==='idle'){ if(!hasRendered) return; renderHeatmap(); showProbeAt(x,y); }
});

/* ==== BUTTON HANDLERS (‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏î‡πÑ‡∏õ‡∏Å‡πà‡∏≠‡∏ô‡∏´‡∏ô‡πâ‡∏≤) ==== */
document.getElementById('btnScale').onclick = ()=> setMode('scale');
document.getElementById('btnIdle').onclick  = ()=> setMode('idle');
document.getElementById('btnAP').onclick    = ()=> setMode('ap');
document.getElementById('btnMat').onclick   = ()=> setMode('mat');

document.getElementById('btnAPUndo').onclick = ()=>{ aps.pop(); drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshAPList(); };
document.getElementById('btnAPClear').onclick= ()=>{ if(confirm('‡∏•‡πâ‡∏≤‡∏á AP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ aps=[]; drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshAPList(); } };

document.getElementById('btnMatUndo').onclick = ()=>{ segments.pop(); drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshMatList(); };
document.getElementById('btnMatClear').onclick= ()=>{ if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ segments=[]; drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshMatList(); } };

document.getElementById('btnRender').onclick  = ()=>{ renderHeatmap(); hideProbe(); };
document.getElementById('btnExport').onclick  = ()=>{ const a=document.createElement('a'); a.download='heatmap.png'; a.href=canvas.toDataURL('image/png'); a.click(); };

document.getElementById('btnApplyPreset').onclick=()=>{
  const p=AP_PRESETS[UI.apPreset.value]; if(!p) return;
  const num=aps.length+1;
  document.getElementById('apLabel').value = `${p.name.split('(')[0].trim()}-${num}`;
  document.getElementById('apP0').value   = p.defaults?.p0 ?? -40;
  UI.apBand.value = p.defaults?.band ?? '5';
  const s=p.spec||{}; const set=(id,v)=>document.getElementById(id).value=v||'';
  set('apSpec_model',s.model); set('apSpec_buttons',s.buttons); set('apSpec_power',s.power);
  set('apSpec_ant',s.antenna); set('apSpec_iface',s.iface); set('apSpec_standards',s.standards);
  set('apSpec_rate',s.rate); set('apSpec_rf',s.rf); set('apSpec_functions',s.functions);
  set('apSpec_cert',s.cert); set('apSpec_sysreq',s.sysreq); set('apSpec_env',s.env); set('apSpec_notes',s.notes);
};

/* Keyboard */
document.addEventListener('keydown', e=>{
  if(appMode!=='planning') return;
  if(e.key==='s'||e.key==='S') setMode('scale');
  if(e.key==='a'||e.key==='A') setMode('ap');
  if(e.key==='w'||e.key==='W') setMode('mat');
  if(e.key==='h'||e.key==='H'){ renderHeatmap(); hideProbe(); }
  if(e.key==='Escape')        setMode('idle');
});

/* Image scale controls */
function setFloorScaleFromInput(v){ const pct=clamp(parseInt(v,10)||75,20,150); UI.imgScale.value=pct; UI.imgScaleNum.value=pct; floorScale=pct/100;
  drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); }
UI.imgScale.addEventListener('input', e=> setFloorScaleFromInput(e.target.value));
UI.imgScaleNum.addEventListener('input', e=> setFloorScaleFromInput(e.target.value));

/* Init */
(function init(){
  applyCanvasCSSSize(); setApp('planning'); setMode('idle'); UI.scaleLabel.textContent='‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á';
  drawBase(); drawPermanent(); UI.apPreset.value='tplink_ax20';
})();
</script>
</body>
</html>
