<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Wi-Fi Heatmap (Static Web App) ‚Äî by you</title>
<style>
  :root{
    --bg:#0f1220; --panel:#171a2b; --muted:#9aa4b2; --text:#e8ecf1;
    --accent:#6ae3ff; --accent2:#7cff9b; --danger:#ff7b7b; --warn:#ffd36a;
    --card:#1b2035; --btn:#232845; --btn2:#2b3156; --ring:#2a7fff55;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(120deg,#0f1220,#0e1428 60%,#0f1220);
       color:var(--text);font:500 16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,"Helvetica Neue",Arial}
  header{padding:14px 18px;border-bottom:1px solid #202540;background:rgba(17,22,36,.7);
         position:sticky;top:0;backdrop-filter:blur(8px);z-index:50}
  header h1{margin:0;font-size:18px;letter-spacing:.2px}
  .container{display:grid;grid-template-columns:340px 1fr;gap:14px;padding:14px;height:calc(100% - 64px)}
  .panel{background:var(--panel);border:1px solid #242a49;border-radius:14px;padding:14px;overflow:auto}
  .section{margin-bottom:14px;padding-bottom:12px;border-bottom:1px dashed #2a3156}
  .section:last-child{border-bottom:0;margin-bottom:0;padding-bottom:0}
  .label{font-size:13px;color:var(--muted);margin:6px 0 6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="file"],input[type="number"],input[type="text"],select{
    background:var(--card);border:1px solid #2a3156;color:var(--text);
    border-radius:10px;padding:8px 10px;outline:none
  }
  input[type="number"]{width:120px}
  button{
    background:var(--btn);border:1px solid #2a3156;color:var(--text);padding:9px 12px;border-radius:11px;
    cursor:pointer;transition:.15s;user-select:none
  }
  button:hover{transform:translateY(-1px);box-shadow:0 6px 18px -10px #000,0 0 0 2px var(--ring)}
  button.ghost{background:transparent;border-color:#333b70}
  button.warn{background:#3a2c12;border-color:#5a4315;color:#ffe8a7}
  button.danger{background:#3a1b1b;border-color:#5a2a2a;color:#ffc6c6}
  .chip{font-size:12px;border:1px solid #2a3156;border-radius:999px;padding:4px 9px;color:var(--muted);display:inline-flex;gap:6px;align-items:center}
  canvas{background:#0b0f1d;border-radius:12px;border:1px solid #263056;max-width:100%}
  .toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  .legend{display:flex;align-items:center;gap:10px}
  .grad{width:180px;height:12px;border-radius:999px;border:1px solid #2a3156}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#222846;border:1px solid #2a3156;border-radius:6px;padding:2px 6px;color:#b9c3ff;font-size:12px}
  .muted{color:var(--muted)}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#22284a;border:1px solid #2a3156}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace}
  .divider{height:1px;background:#28305a;margin:10px 0}
  .small{font-size:12px}
  a{color:#8fd3ff;text-decoration:none}
  .point{display:flex;justify-content:space-between;gap:10px;background:#131a33;border:1px solid #2a3156;
         border-radius:10px;padding:8px}
  .point strong{font-weight:700}
  .footer{color:#8b95a7;font-size:12px;text-align:center;padding:10px}
  @media (max-width: 980px){
    .container{grid-template-columns:1fr}
  }
</style>
</head>
<body>
<header>
  <h1>üì∂ Wi-Fi Heatmap ‚Äî Static Web App (GitHub Pages Ready)</h1>
</header>

<div class="container">
  <!-- Left control panel -->
  <aside class="panel" id="panel">
    <div class="section">
      <div class="label">1) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏õ‡∏•‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (PNG/JPG)</div>
      <div class="row">
        <input type="file" id="fileInput" accept="image/*" />
        <button id="btnClear">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
      <div class="small muted">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡πÉ‡∏ä‡πâ‡∏£‡∏π‡∏õ‡∏™‡∏±‡∏î‡∏™‡πà‡∏ß‡∏ô‡πÄ‡∏ó‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡πÅ‡∏°‡πà‡∏ô‡∏Ç‡∏≠‡∏á‡∏™‡πÄ‡∏Å‡∏•</div>
    </div>

    <div class="section">
      <div class="label">2) ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á</div>
      <div class="row">
        <button id="btnScale" title="‡∏Ñ‡∏•‡∏¥‡∏Å 2 ‡∏à‡∏∏‡∏î‡∏ö‡∏ô‡∏†‡∏≤‡∏û‡πÅ‡∏•‡πâ‡∏ß‡∏Å‡∏£‡∏≠‡∏Å‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏£‡∏¥‡∏á">üß≠ ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•‡∏î‡πâ‡∏ß‡∏¢‡∏Å‡∏≤‡∏£‡∏•‡∏≤‡∏Å 2 ‡∏à‡∏∏‡∏î</button>
        <span class="chip">‡∏™‡πÄ‡∏Å‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="scaleLabel">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á</span></span>
      </div>
      <div class="small muted">‡∏ú‡∏•‡∏•‡∏±‡∏û‡∏ò‡πå‡πÉ‡∏ä‡πâ‡∏ó‡∏±‡πâ‡∏á‡∏Å‡∏±‡∏ö Legend ‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏±‡∏®‡∏°‡∏µ‡πÉ‡∏ô‡∏ï‡∏±‡∏ß‡πÅ‡∏Å‡∏ô RBF</div>
    </div>

    <div class="section">
      <div class="label">3) ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì</div>
      <div class="grid">
        <div>
          <div class="label">SSID/Note</div>
          <input type="text" id="ssidInput" placeholder="‡πÄ‡∏ä‡πà‡∏ô Home-AP ‡∏´‡∏£‡∏∑‡∏≠ ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏" />
        </div>
        <div>
          <div class="label">RSSI (dBm)</div>
          <input type="number" id="rssiInput" value="-60" step="1" />
        </div>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnPoint">üìç ‡πÇ‡∏´‡∏°‡∏î‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î (‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏†‡∏≤‡∏û)</button>
        <button id="btnUndo" class="ghost">‚Ü©Ô∏è ‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        <button id="btnClearPts" class="danger">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏∏‡∏Å‡∏à‡∏∏‡∏î</button>
      </div>
      <div class="small muted">‡∏Ñ‡πà‡∏≤‡∏°‡∏≤‡∏Å‡πÉ‡∏Å‡∏•‡πâ 0 = ‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏£‡∏á (‡πÄ‡∏ä‡πà‡∏ô -40 ‡∏î‡∏µ‡∏°‡∏≤‡∏Å) / ‡∏Ñ‡πà‡∏≤‡∏ï‡∏¥‡∏î‡∏•‡∏ö‡∏°‡∏≤‡∏Å = ‡∏≠‡πà‡∏≠‡∏ô</div>
      <div id="pointList" style="margin-top:10px;display:grid;gap:6px;"></div>
    </div>

    <div class="section">
      <div class="label">4) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ Heatmap</div>
      <div class="grid">
        <div>
          <div class="label">‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì</div>
          <select id="method">
            <option value="idw">IDW (Inverse Distance Weighting) ‚Äî ‡πÄ‡∏£‡πá‡∏ß</option>
            <option value="rbf" selected>RBF (Gaussian) ‚Äî ‡πÅ‡∏°‡πà‡∏ô‡∏Å‡∏ß‡πà‡∏≤</option>
          </select>
        </div>
        <div>
          <div class="label">Grid step (px)</div>
          <input type="number" id="gridStep" value="6" min="2" step="1" />
        </div>
        <div>
          <div class="label">RBF epsilon (px‚Åª¬π)</div>
          <input type="number" id="epsilon" value="0.01" step="0.005" />
        </div>
        <div>
          <div class="label">IDW power</div>
          <input type="number" id="idwPow" value="2" step="0.5" />
        </div>
        <div>
          <div class="label">‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡∏Æ‡∏µ‡∏ï‡πÅ‡∏°‡∏õ</div>
          <input type="number" id="alpha" value="0.6" min="0" max="1" step="0.05" />
        </div>
        <div>
          <div class="label">‡∏û‡∏≤‡πÄ‡∏•‡∏ï‡∏™‡∏µ</div>
          <select id="palette">
            <option value="turbo" selected>Turbo (‡∏î‡∏µ‚Üí‡πÅ‡∏¢‡πà: ‡∏ü‡πâ‡∏≤‚Üí‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á‚Üí‡πÅ‡∏î‡∏á)</option>
            <option value="viridis">Viridis</option>
            <option value="inferno">Inferno</option>
            <option value="jet">Jet</option>
          </select>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnRender">üî• ‡∏™‡∏£‡πâ‡∏≤‡∏á Heatmap</button>
        <button id="btnExport">üñºÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PNG</button>
      </div>
      <div class="legend" style="margin-top:10px">
        <div id="grad" class="grad"></div>
        <div class="small"><span id="legendMin">-100</span> dBm ‚ü∑ <span id="legendMax">-30</span> dBm</div>
      </div>
    </div>

    <div class="section">
      <div class="label">5) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÇ‡∏´‡∏•‡∏î‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î</div>
      <div class="row">
        <button id="btnSave">üíæ Save JSON</button>
        <input type="file" id="loadJson" accept="application/json" />
      </div>
      <div class="small muted">‡πÑ‡∏ü‡∏•‡πå JSON ‡∏à‡∏∞‡πÄ‡∏Å‡πá‡∏ö: ‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î, ‡∏ß‡∏¥‡∏ò‡∏µ‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì, gridStep, epsilon, idwPower ‡∏Ø‡∏•‡∏Ø</div>
    </div>

    <div class="section small muted">
      ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î: <span class="kbd">S</span> ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏• ‚Ä¢ <span class="kbd">P</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î ‚Ä¢ <span class="kbd">H</span> ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏Æ‡∏µ‡∏ï‡πÅ‡∏°‡∏õ ‚Ä¢ <span class="kbd">Z</span> ‡∏•‡∏ö‡∏à‡∏∏‡∏î‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î
    </div>

    <div class="footer">¬© ‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏õ‡πá‡∏ô‡πÄ‡∏à‡πâ‡∏≤‡∏Ç‡∏≠‡∏á‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå‡∏ô‡∏µ‡πâ‡∏ö‡∏ô GitHub ‚Äî ‡πÇ‡∏Ñ‡πâ‡∏î‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÑ‡∏•‡πÄ‡∏ã‡∏ô‡∏™‡πå‡∏ú‡∏π‡∏Å‡∏°‡∏±‡∏î ‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ/‡πÅ‡∏à‡∏Å‡πÑ‡∏î‡πâ</div>
  </aside>

  <!-- Right canvas/workspace -->
  <main class="panel" style="display:flex;flex-direction:column;gap:10px">
    <div class="toolbar">
      <span class="badge" id="modeBadge">‡πÇ‡∏´‡∏°‡∏î: ‡∏õ‡∏Å‡∏ï‡∏¥</span>
      <span class="muted small">‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡πÅ‡∏Ñ‡∏ô‡∏ß‡∏≤‡∏™‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏°‡πÇ‡∏´‡∏°‡∏î‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</span>
    </div>
    <canvas id="canvas" width="1280" height="800"></canvas>
    <div class="small muted">‡∏Ñ‡∏≥‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥: ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡∏Å‡πà‡∏≠‡∏ô ‡∏à‡∏≤‡∏Å‡∏ô‡∏±‡πâ‡∏ô‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏• ‚Üí ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î ‚Üí ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Æ‡∏µ‡∏ï‡πÅ‡∏°‡∏õ</div>
  </main>
</div>

<script>
/* ========= Utilities ========= */
const $ = sel => document.querySelector(sel);
const clamp = (v,a,b)=>Math.max(a,Math.min(b,v));
const dist = (a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const lerp = (a,b,t)=>a+(b-a)*t;

/* üëá ‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÉ‡∏´‡∏°‡πà: ‡πÅ‡∏õ‡∏•‡∏á‡∏à‡∏∏‡∏î‡∏Ñ‡∏•‡∏¥‡∏Å‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏û‡∏¥‡∏Å‡∏±‡∏î‡∏à‡∏£‡∏¥‡∏á‡∏ö‡∏ô‡πÅ‡∏Ñ‡∏ô‡∏ß‡∏≤‡∏™ */
function getCanvasPos(e){
  const rect = canvas.getBoundingClientRect();
  const scaleX = canvas.width  / rect.width;
  const scaleY = canvas.height / rect.height;
  return {
    x: (e.clientX - rect.left) * scaleX,
    y: (e.clientY - rect.top)  * scaleY
  };
}

function download(filename, data, type="application/json"){
  const blob = new Blob([data], {type});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url; a.download = filename; a.click();
  URL.revokeObjectURL(url);
}

/* ========= Canvas & State ========= */
const canvas = $('#canvas');
const ctx = canvas.getContext('2d', { willReadFrequently:true });

let floorImg = null;
let points = []; // {x,y,rssi,label}
let mode = 'idle'; // 'scale'|'add'
let scale = { pxPerMeter: null }; // computed by 2-click ruler
let tempLine = null; // {a:{x,y}, b:{x,y}}
let rbfWeights = null;

const UI = {
  scaleLabel: $('#scaleLabel'),
  modeBadge: $('#modeBadge'),
  pointList: $('#pointList'),
  legendMin: $('#legendMin'),
  legendMax: $('#legendMax'),
};

/* ========= Image handling ========= */
function fitCanvasToImage(img){
  const maxW = 1920, maxH = 1080;
  let w = img.width, h = img.height;
  const k = Math.min(maxW/w, maxH/h, 1);
  canvas.width = Math.round(w*k);
  canvas.height = Math.round(h*k);
}

function drawAll(){
  // bg
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(floorImg){
    ctx.drawImage(floorImg, 0,0, canvas.width, canvas.height);
  } else {
    // grid bg
    ctx.fillStyle = '#0c1022';
    ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle = '#1c264a';
    ctx.lineWidth = 1;
    for(let x=0;x<canvas.width;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke()}
    for(let y=0;y<canvas.height;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke()}
  }
  // temp scale line
  if(tempLine){
    ctx.strokeStyle = '#8fd3ff';
    ctx.lineWidth = 2.5;
    ctx.setLineDash([8,6]);
    ctx.beginPath();
    ctx.moveTo(tempLine.a.x,tempLine.a.y);
    ctx.lineTo(tempLine.b.x,tempLine.b.y);
    ctx.stroke();
    ctx.setLineDash([]);
    // length preview
    const Lpx = dist(tempLine.a,tempLine.b);
    ctx.fillStyle = '#8fd3ff';
    ctx.font = '12px ui-monospace,monospace';
    ctx.fillText(`${Lpx.toFixed(1)} px`, tempLine.b.x+8, tempLine.b.y-6);
  }

  // points
  for(const p of points){
    drawPoint(p);
  }
}

function drawPoint(p){
  ctx.shadowColor = '#0008';
  ctx.shadowBlur = 8;
  ctx.fillStyle = '#7cff9b';
  ctx.beginPath();
  ctx.arc(p.x,p.y,6,0,Math.PI*2);
  ctx.fill();
  ctx.shadowBlur = 0;
  ctx.strokeStyle = '#1b8a5f';
  ctx.lineWidth = 2;
  ctx.stroke();

  ctx.fillStyle = '#e8ecf1';
  ctx.font = '12px ui-monospace,monospace';
  const label = `${p.rssi} dBm${p.label?` ¬∑ ${p.label}`:''}`;
  ctx.fillText(label, p.x+10, p.y-8);
}

/* ========= Palette ========= */
function makeGradient(palette='turbo'){
  const g = $('#grad');
  const cvs = document.createElement('canvas');
  cvs.width = 256; cvs.height = 1;
  const c = cvs.getContext('2d');
  const gr = c.createLinearGradient(0,0,256,0);
  const stops = {
    turbo: [[0,'#30123b'],[0.2,'#4145ae'],[0.4,'#2ec7f0'],[0.6,'#7df87b'],[0.8,'#f4e55c'],[1,'#fb4a2a']],
    viridis: [[0,'#440154'],[0.25,'#3b528b'],[0.5,'#21918c'],[0.75,'#5dc963'],[1,'#fde725']],
    inferno: [[0,'#000004'],[0.2,'#2c115f'],[0.4,'#721f81'],[0.6,'#b73779'],[0.8,'#f1605d'],[1,'#fcfdbf']],
    jet: [[0,'#00007F'],[0.35,'#00FFFF'],[0.5,'#7FFF7F'],[0.65,'#FFFF00'],[1,'#7F0000']]
  }[palette] || stops.turbo;
  for(const [t,col] of stops) gr.addColorStop(t,col);
  c.fillStyle = gr; c.fillRect(0,0,256,1);
  g.style.backgroundImage = `url(${cvs.toDataURL()})`;
  return (t)=>{
    const x = clamp(Math.round(t*255),0,255);
    const d = c.getImageData(x,0,1,1).data;
    return `rgba(${d[0]},${d[1]},${d[2]},1)`;
  };
}
let colorAt = makeGradient('turbo');

/* ========= Interpolators ========= */
// IDW
function idwValue(x,y, pts, power=2){
  let num=0, den=0;
  for(const p of pts){
    const d = Math.hypot(x-p.x,y-p.y);
    const w = (d<1e-6)? 1e6 : 1/Math.pow(d,power);
    num += w * p.rssi;
    den += w;
  }
  return num/den;
}

// RBF (Gaussian kernel)
function buildRbfWeights(pts, eps){
  const n = pts.length;
  const A = Array.from({length:n},()=>Array(n).fill(0));
  for(let i=0;i<n;i++){
    for(let j=0;j<n;j++){
      const r = Math.hypot(pts[i].x-pts[j].x, pts[i].y-pts[j].y);
      A[i][j] = Math.exp(- (eps*eps) * r*r);
    }
  }
  const b = pts.map(p=>p.rssi);
  // Solve A w = b (Gaussian elimination)
  const w = b.slice();
  // augment
  for(let i=0;i<n;i++){ A[i].push(w[i]); }
  for(let i=0;i<n;i++){
    // pivot
    let maxR=i;
    for(let r=i+1;r<n;r++){ if(Math.abs(A[r][i])>Math.abs(A[maxR][i])) maxR=r; }
    if(maxR!==i){ const tmp=A[i]; A[i]=A[maxR]; A[maxR]=tmp; }
    const piv = A[i][i] || 1e-12;
    for(let j=i;j<=n;j++) A[i][j]/=piv;
    for(let r=0;r<n;r++){
      if(r===i) continue;
      const f = A[r][i];
      for(let j=i;j<=n;j++) A[r][j]-=f*A[i][j];
    }
  }
  const sol = Array(n);
  for(let i=0;i<n;i++) sol[i]=A[i][n];
  return sol;
}
function rbfValue(x,y, pts, eps, weights){
  let s=0;
  for(let i=0;i<pts.length;i++){
    const r = Math.hypot(x-pts[i].x, y-pts[i].y);
    s += weights[i] * Math.exp(- (eps*eps) * r*r);
  }
  return s;
}

/* ========= Heatmap render ========= */
function renderHeatmap(){
  if(!floorImg){ alert('‡πÇ‡∏õ‡∏£‡∏î‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏†‡∏≤‡∏û‡πÅ‡∏õ‡∏•‡∏ô‡∏Å‡πà‡∏≠‡∏ô'); return; }
  if(points.length<2){ alert('‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 2 ‡∏à‡∏∏‡∏î'); return; }

  const method = $('#method').value;
  const gridStep = parseInt($('#gridStep').value || '6',10);
  const alpha = clamp(parseFloat($('#alpha').value||'0.6'), 0,1);

  colorAt = makeGradient($('#palette').value);

  // compute value range from points (for legend)
  let vmin = +Infinity, vmax = -Infinity;
  for(const p of points){ vmin=Math.min(vmin,p.rssi); vmax=Math.max(vmax,p.rssi); }
  UI.legendMin.textContent = vmin.toFixed(0);
  UI.legendMax.textContent = vmax.toFixed(0);

  // precompute RBF weights if needed
  if(method==='rbf'){
    const eps = parseFloat($('#epsilon').value||'0.01');
    rbfWeights = buildRbfWeights(points, eps);
  }

  // draw base image
  drawAll();

  // paint heatmap on top
  const imgData = ctx.getImageData(0,0,canvas.width,canvas.height);
  const data = imgData.data;

  // sample on grid, then write small blocks for speed
  const block = Math.max(2, gridStep|0);
  const eps = parseFloat($('#epsilon').value||'0.01');
  const pwr = parseFloat($('#idwPow').value||'2');

  for(let y=0;y<canvas.height;y+=block){
    for(let x=0;x<canvas.width;x+=block){
      let val;
      if(method==='idw'){
        val = idwValue(x,y,points,pwr);
      } else {
        val = rbfValue(x,y,points,eps,rbfWeights);
      }
      const t = clamp((val - vmin) / Math.max(1e-9,(vmax - vmin)), 0,1);
      const col = colorAt(1-t); // 1-t: ‡∏™‡∏µ‡∏ü‡πâ‡∏≤=‡∏î‡∏µ (‡∏Ñ‡πà‡∏≤‡∏ï‡πà‡∏≥‚Üí‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì‡πÅ‡∏£‡∏á)
      // parse color
      const m = col.match(/rgba\((\d+),(\d+),(\d+),/);
      const r = +m[1], g=+m[2], b=+m[3];

      for(let yy=0; yy<block; yy++){
        if(y+yy>=canvas.height) break;
        for(let xx=0; xx<block; xx++){
          if(x+xx>=canvas.width) break;
          const idx = ((y+yy)*canvas.width + (x+xx)) * 4;
          // alpha blend over background
          const A = alpha;
          data[idx+0] = r*A + data[idx+0]*(1-A);
          data[idx+1] = g*A + data[idx+1]*(1-A);
          data[idx+2] = b*A + data[idx+2]*(1-A);
          data[idx+3] = 255;
        }
      }
    }
  }
  ctx.putImageData(imgData,0,0);

  // draw points again on top
  for(const p of points) drawPoint(p);
}

/* ========= UI: points list ========= */
function refreshPointList(){
  UI.pointList.innerHTML = '';
  points.forEach((p,i)=>{
    const el = document.createElement('div');
    el.className = 'point small';
    el.innerHTML = `<div><strong>${p.rssi} dBm</strong> ¬∑ ${p.label?escapeHtml(p.label):'<span class="muted">‚Äî</span>'}
                    <div class="muted">(${p.x|0}, ${p.y|0})</div></div>
                    <div><button data-i="${i}" class="danger" style="padding:4px 8px">‡∏•‡∏ö</button></div>`;
    el.querySelector('button').onclick = e=>{
      const idx = +e.target.getAttribute('data-i');
      points.splice(idx,1);
      drawAll(); refreshPointList();
    };
    UI.pointList.appendChild(el);
  });
}
function escapeHtml(s){ return s.replace(/[&<>"']/g, m=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' }[m])); }

/* ========= Modes ========= */
function setMode(m){
  mode = m;
  UI.modeBadge.textContent = `‡πÇ‡∏´‡∏°‡∏î: ${m==='idle'?'‡∏õ‡∏Å‡∏ï‡∏¥': m==='scale'?'‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏• (‡∏Ñ‡∏•‡∏¥‡∏Å 2 ‡∏à‡∏∏‡∏î)':'‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏∏‡∏î'}`;
}

/* ========= Events ========= */
$('#fileInput').addEventListener('change', e=>{
  const f = e.target.files[0];
  if(!f) return;
  const img = new Image();
  img.onload = ()=>{
    floorImg = document.createElement('canvas');
    floorImg.width = img.width; floorImg.height = img.height;
    const c = floorImg.getContext('2d');
    c.drawImage(img,0,0);
    fitCanvasToImage(img);
    points = [];
    tempLine=null; scale.pxPerMeter=null;
    UI.scaleLabel.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á';
    drawAll();
    refreshPointList();
  };
  img.src = URL.createObjectURL(f);
});

$('#btnClear').onclick = ()=>{
  floorImg = null;
  points = [];
  tempLine = null;
  scale.pxPerMeter = null;
  UI.scaleLabel.textContent = '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á';
  drawAll(); refreshPointList();
};

$('#btnScale').onclick = ()=> setMode('scale');
$('#btnPoint').onclick = ()=> setMode('add');
$('#btnUndo').onclick = ()=>{
  points.pop();
  drawAll(); refreshPointList();
};
$('#btnClearPts').onclick = ()=>{
  if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏à‡∏∏‡∏î‡∏ß‡∏±‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ points=[]; drawAll(); refreshPointList(); }
};
$('#btnRender').onclick = renderHeatmap;

$('#btnExport').onclick = ()=>{
  const link = document.createElement('a');
  link.download = 'heatmap.png';
  link.href = canvas.toDataURL('image/png');
  link.click();
};

$('#btnSave').onclick = ()=>{
  const payload = {
    points, method: $('#method').value,
    gridStep: +($('#gridStep').value||6),
    epsilon: +($('#epsilon').value||0.01),
    idwPow: +($('#idwPow').value||2),
    alpha: +($('#alpha').value||0.6),
    palette: $('#palette').value,
    scale: scale.pxPerMeter
  };
  download('heatmap_data.json', JSON.stringify(payload,null,2));
};

$('#loadJson').addEventListener('change', e=>{
  const f = e.target.files[0]; if(!f) return;
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      points = obj.points||[];
      $('#method').value = obj.method||'rbf';
      $('#gridStep').value = obj.gridStep||6;
      $('#epsilon').value = obj.epsilon||0.01;
      $('#idwPow').value = obj.idwPow||2;
      $('#alpha').value = obj.alpha||0.6;
      $('#palette').value = obj.palette||'turbo';
      scale.pxPerMeter = obj.scale||null;
      UI.scaleLabel.textContent = scale.pxPerMeter? `${(scale.pxPerMeter).toFixed(1)} px/‡πÄ‡∏°‡∏ï‡∏£` : '‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á';
      colorAt = makeGradient($('#palette').value);
      drawAll(); refreshPointList();
    }catch(err){ alert('‡πÑ‡∏ü‡∏•‡πå JSON ‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); }
  };
  reader.readAsText(f);
});

/* ‚úÖ ‡πÉ‡∏ä‡πâ‡∏ï‡∏≥‡πÅ‡∏´‡∏ô‡πà‡∏á‡∏Ñ‡∏•‡∏¥‡∏Å‡πÅ‡∏ö‡∏ö‡πÅ‡∏Å‡πâ‡πÄ‡∏¢‡∏∑‡πâ‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß */
canvas.addEventListener('click', e=>{
  const {x, y} = getCanvasPos(e);

  if(mode==='scale'){
    if(!tempLine){ tempLine = {a:{x,y}, b:{x,y}}; }
    else{
      tempLine.b = {x,y};
      const Lpx = dist(tempLine.a,tempLine.b);
      const real = prompt(`‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏ï‡∏£) ‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${Lpx.toFixed(1)} px = ?`, '5');
      if(real && +real>0){
        scale.pxPerMeter = Lpx / (+real);
        UI.scaleLabel.textContent = `${scale.pxPerMeter.toFixed(1)} px/‡πÄ‡∏°‡∏ï‡∏£`;
      }
      tempLine = null;
      setMode('idle');
    }
    drawAll();
  } else if(mode==='add'){
    const rssi = parseFloat($('#rssiInput').value||'-60');
    const label = $('#ssidInput').value.trim();
    points.push({x,y,rssi,label});
    drawAll(); refreshPointList();
  }
});

canvas.addEventListener('mousemove', e=>{
  if(mode==='scale' && tempLine){
    const {x, y} = getCanvasPos(e);
    tempLine.b = {x, y};
    drawAll();
  }
});

document.addEventListener('keydown', e=>{
  if(e.key==='s' || e.key==='S'){ setMode('scale'); }
  if(e.key==='p' || e.key==='P'){ setMode('add'); }
  if(e.key==='h' || e.key==='H'){ renderHeatmap(); }
  if(e.key==='z' || e.key==='Z'){ points.pop(); drawAll(); refreshPointList(); }
});

/* init */
drawAll();
colorAt = makeGradient('turbo');
UI.modeBadge.textContent = '‡πÇ‡∏´‡∏°‡∏î: ‡∏õ‡∏Å‡∏ï‡∏¥';
</script>
</body>
</html>
