<!doctype html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Wi-Fi Heatmap ‚Äî Survey / Planning</title>
<style>
  :root{ --bg:#0f1220; --panel:#171a2b; --muted:#9aa4b2; --text:#e8ecf1;
         --card:#1b2035; --btn:#232845; --ring:#2a7fff55; --danger:#ff7b7b; }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(120deg,#0f1220,#0e1428 60%,#0f1220);
       color:var(--text);font:500 16px/1.45 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
  header{padding:12px 16px;border-bottom:1px solid #202540;background:rgba(17,22,36,.7);
         position:sticky;top:0;backdrop-filter:blur(8px);z-index:50;display:flex;align-items:center;gap:10px}
  header h1{margin:0;font-size:18px;flex:1}
  .mode-switch{display:flex;gap:6px}
  .pill{padding:6px 10px;border-radius:999px;border:1px solid #2a3156;background:#1a1f39;color:#cfd6ff;cursor:pointer}
  .pill.active{background:#2a3569;border-color:#3d4c9a;color:#fff;box-shadow:0 0 0 2px var(--ring)}
  .container{display:grid;grid-template-columns:380px 1fr;gap:14px;padding:14px;height:calc(100% - 56px)}
  .panel{background:var(--panel);border:1px solid #242a49;border-radius:14px;padding:14px;overflow:auto}
  .section{margin-bottom:14px;padding-bottom:12px;border-bottom:1px dashed #2a3156}
  .section:last-child{border-bottom:0;margin-bottom:0;padding-bottom:0}
  .label{font-size:13px;color:var(--muted);margin:6px 0 6px}
  .row{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
  input[type="file"],input[type="number"],input[type="text"],select,textarea{
    background:var(--card);border:1px solid #2a3156;color:var(--text);
    border-radius:10px;padding:8px 10px;outline:none
  }
  textarea{width:100%;min-height:54px;resize:vertical}
  input[type="number"]{width:120px}
  input[type="range"]{width:180px}
  button{
    background:var(--btn);border:1px solid #2a3156;color:var(--text);padding:9px 12px;border-radius:11px;
    cursor:pointer;transition:.15s;user-select:none
  }
  button:hover{transform:translateY(-1px);box-shadow:0 6px 18px -10px #000,0 0 0 2px var(--ring)}
  button.danger{background:#3a1b1b;border-color:#5a2a2a;color:#ffc6c6}
  .chip{font-size:12px;border:1px solid #2a3156;border-radius:999px;padding:4px 9px;color:var(--muted);display:inline-flex;gap:6px;align-items:center}
  .legend{display:flex;align-items:center;gap:10px}
  .grad{width:220px;height:12px;border-radius:999px;border:1px solid #2a3156}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .grid-1{display:grid;grid-template-columns:1fr;gap:8px}
  .kbd{font-family:ui-monospace,Menlo,Consolas,monospace;background:#222846;border:1px solid #2a3156;border-radius:6px;padding:2px 6px;color:#b9c3ff;font-size:12px}
  .muted{color:var(--muted)}
  .badge{font-size:12px;padding:4px 8px;border-radius:999px;background:#22284a;border:1px solid #2a3156}
  .small{font-size:12px}
  .apRow,.matRow{display:flex;justify-content:space-between;gap:8px;align-items:center;background:#141a34;border:1px solid #2a3156;border-radius:10px;padding:6px 8px}
  .dot{width:10px;height:10px;border-radius:50%}
  details.spec details{margin-left:10px}
  details.spec>summary{cursor:pointer;padding:6px 10px;border:1px solid #2a3156;border-radius:8px;background:#1b2141}
  @media (max-width:980px){ .container{grid-template-columns:1fr} }

  .stage{position:relative;display:inline-block}
  #canvas,#overlay{display:block}
  #overlay{position:absolute; left:0; top:0; pointer-events:none; z-index:3;}
  #probe{position:absolute;display:none;transform:translate(10px,-10px);
         background:#0e1329;border:1px solid #2a3156;border-radius:10px;padding:6px 8px;
         color:#e8ecf1;font:600 13px ui-monospace,monospace;pointer-events:none;z-index:4;
         box-shadow:0 6px 20px rgba(0,0,0,.35)}
  #probe .sw{display:inline-block;width:10px;height:10px;border-radius:50%;margin-right:6px;border:1px solid #0006}
  #probe .sub{font-weight:500;color:#9aa4b2;margin-top:2px}

  #modePicker{
    position:fixed; inset:0; background:linear-gradient(180deg, rgba(5,8,22,.85), rgba(10,14,34,.85));
    display:flex; align-items:center; justify-content:center; z-index:80;
  }
  .pickerBox{
    background:#141a2e;border:1px solid #2a3156;border-radius:16px;padding:22px;max-width:520px;width:92%;
    box-shadow:0 18px 60px rgba(0,0,0,.45)
  }
  .pickerTitle{font-size:18px;margin:0 0 12px}
  .pickerRow{display:flex;gap:12px;flex-wrap:wrap}
  .pickBtn{flex:1;min-width:180px;padding:16px;border-radius:14px;border:1px solid #2a3156;background:#1b2141;color:#e8ecf1;cursor:pointer}
  .pickBtn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(0,0,0,.35)}
  .pickHint{font-size:12px;color:#9aa4b2;margin-top:10px}
  .surveyBlank{
    background:#ffffff;border-radius:12px;border:1px dashed #cccccc; min-height:300px;
    display:flex;align-items:center;justify-content:center;color:#333;font:600 18px/1.3 ui-sans-serif,system-ui
  }
</style>
</head>
<body>
<header>
  <h1>üì∂ Wi-Fi Heatmap</h1>
  <div class="mode-switch">
    <div class="pill active" id="pillPlanning">Planning</div>
    <div class="pill" id="pillSurvey">Survey</div>
  </div>
</header>

<!-- Startup picker -->
<div id="modePicker">
  <div class="pickerBox">
    <h2 class="pickerTitle">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÇ‡∏´‡∏°‡∏î‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡∏á‡∏≤‡∏ô</h2>
    <div class="pickerRow">
      <button class="pickBtn" id="pickPlanning">üõ†Ô∏è Planning ‚Äî ‡∏ß‡∏≤‡∏á AP / ‡∏ß‡∏±‡∏™‡∏î‡∏∏ / ‡∏™‡∏£‡πâ‡∏≤‡∏á Heatmap</button>
      <button class="pickBtn" id="pickSurvey">üß™ Survey ‚Äî (‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡πà‡∏≤‡∏á‡πÄ‡∏õ‡∏•‡πà‡∏≤) ‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡πà‡∏≠‡∏†‡∏≤‡∏¢‡∏´‡∏•‡∏±‡∏á</button>
    </div>
    <div class="pickHint">‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏•‡∏±‡∏ö‡πÇ‡∏´‡∏°‡∏î‡πÑ‡∏î‡πâ‡∏ó‡∏µ‡πà‡∏°‡∏∏‡∏°‡∏Ç‡∏ß‡∏≤‡∏ö‡∏ô‡∏ï‡∏•‡∏≠‡∏î‡πÄ‡∏ß‡∏•‡∏≤</div>
  </div>
</div>

<div class="container" id="appPlanning" style="display:grid">
  <!-- Left control panel -->
  <aside class="panel">
    <div class="section">
      <div class="label">1) ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÅ‡∏õ‡∏•‡∏ô‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà (PNG/JPG)</div>
      <div class="row">
        <input type="file" id="fileInput" accept="image/*"/>
        <button id="btnClear">‡∏•‡πâ‡∏≤‡∏á</button>
      </div>
      <div class="row" style="margin-top:8px">
        <div class="label">‡∏Ç‡∏ô‡∏≤‡∏î‡πÅ‡∏õ‡∏•‡∏ô (%)</div>
        <input type="range" id="imgScale" min="20" max="150" step="5" value="75"/>
        <input type="number" id="imgScaleNum" min="20" max="150" step="1" value="75" style="width:80px"/>
        <span class="small muted">‡∏¢‡πà‡∏≠/‡∏Ç‡∏¢‡∏≤‡∏¢‡πÄ‡∏â‡∏û‡∏≤‡∏∞‡∏†‡∏≤‡∏û‡πÅ‡∏õ‡∏•‡∏ô (‡πÑ‡∏°‡πà‡∏Å‡∏£‡∏∞‡∏ó‡∏ö‡∏Ñ‡πà‡∏≤‡∏û‡∏¥‡∏Å‡∏±‡∏î)</span>
      </div>
    </div>

    <div class="section">
      <div class="label">2) ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•‡∏´‡∏ô‡πà‡∏ß‡∏¢‡∏à‡∏£‡∏¥‡∏á</div>
      <div class="row">
        <button id="btnScale">üß≠ ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏• (‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‚Äì‡∏•‡∏≤‡∏Å‚Äì‡∏õ‡∏•‡πà‡∏≠‡∏¢)</button>
        <span class="chip">‡∏™‡πÄ‡∏Å‡∏•‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô: <span id="scaleLabel">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á</span></span>
      </div>
      <div class="small muted">‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏π‡πâ‡∏≠‡∏±‡∏ï‡∏£‡∏≤ px/‡πÄ‡∏°‡∏ï‡∏£ ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏≥‡∏ô‡∏ß‡∏ì‡∏£‡∏∞‡∏¢‡∏∞‡∏à‡∏≤‡∏Å AP ‚Üí ‡∏ó‡∏∏‡∏Å‡∏û‡∏¥‡∏Å‡∏±‡∏î</div>
    </div>

    <div class="section">
      <div class="label">3) ‡∏ß‡∏≤‡∏á Access Point</div>
      <div class="grid">
        <div>
          <div class="label">‡∏ä‡∏∑‡πà‡∏≠/SSID</div>
          <input type="text" id="apLabel" placeholder="‡πÄ‡∏ä‡πà‡∏ô AP-1"/>
        </div>
        <div>
          <div class="label">P‚ÇÄ @1 m (dBm)</div>
          <input type="number" id="apP0" value="-40" step="1"/>
        </div>
        <div>
          <div class="label">n (Path-loss exponent)</div>
          <input type="number" id="apN" value="2.2" step="0.1"/>
        </div>
      </div>

      <!-- Lock n for all APs -->
      <div class="row" style="margin-top:6px; gap:10px">
        <label class="chip" style="gap:6px">
          <input type="checkbox" id="lockN" style="margin-right:6px"/>
          ‡∏•‡πá‡∏≠‡∏Å n ‡∏ó‡∏∏‡∏Å AP
        </label>
        <input type="number" id="lockNValue" value="2.2" step="0.1" title="‡∏Ñ‡πà‡∏≤ n ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏Å‡∏±‡∏ö‡∏ó‡∏∏‡∏Å AP ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏¥‡∏î‡∏•‡πá‡∏≠‡∏Å"/>
      </div>

      <!-- NEW: AP Specifications form -->
      <details class="spec" style="margin-top:10px">
        <summary>üßæ ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏™‡πÄ‡∏õ‡∏Å AP (‡∏ï‡πà‡∏≠ AP ‡∏ó‡∏µ‡πà‡∏à‡∏∞‡∏ß‡∏≤‡∏á)</summary>
        <div class="grid-1" style="margin-top:8px">
          <div class="label">‡∏£‡∏∏‡πà‡∏ô/‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏•‡∏¥‡∏ï‡∏†‡∏±‡∏ì‡∏ë‡πå</div>
          <input type="text" id="apSpec_model" placeholder="‡πÄ‡∏ä‡πà‡∏ô AX1800 Dual-Band Wi-Fi 6 Router"/>

          <div class="label">‡∏õ‡∏∏‡πà‡∏° (Buttons)</div>
          <textarea id="apSpec_buttons" placeholder="Reset, WPS/Wi-Fi, Power On/Off, LED On/Off"></textarea>

          <div class="label">‡πÅ‡∏´‡∏•‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏ü (External Power Supply)</div>
          <input type="text" id="apSpec_power" placeholder="12 V ‚éì 1.5 A"/>

          <div class="label">‡πÄ‡∏™‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏® (Antenna)</div>
          <input type="text" id="apSpec_ant" placeholder="4x Fixed High-Performance Antennas"/>

          <div class="label">‡∏û‡∏≠‡∏£‡πå‡∏ï/‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ü‡∏ã (Interface)</div>
          <textarea id="apSpec_iface" placeholder="1√ó Gigabit WAN, 4√ó Gigabit LAN"></textarea>

          <div class="label">‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô & ‡∏¢‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà (Wireless Standards / Frequency)</div>
          <textarea id="apSpec_standards" placeholder="Wi-Fi 6 (802.11ax), 5 GHz: ax/ac/n/a, 2.4 GHz: ax/n/b/g; Bands: 2.4 & 5 GHz"></textarea>

          <div class="label">‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• (Signal Rate)</div>
          <textarea id="apSpec_rate" placeholder="AX1800 ‚Äî 5 GHz: 1201 Mbps, 2.4 GHz: 574 Mbps"></textarea>

          <div class="label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì (Reception Sensitivity)</div>
          <input type="text" id="apSpec_rx" placeholder="(‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡πÄ‡∏•‡∏Ç‡∏à‡∏≤‡∏Å‡∏™‡πÄ‡∏õ‡∏Å‡∏ä‡∏µ‡∏ï)"/>

          <div class="label">‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏¢ (Wireless Functions)</div>
          <textarea id="apSpec_functions" placeholder="SPI Firewall, Access Control, IP/MAC Binding, App Layer ..."></textarea>

          <div class="label">‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á (Certification)</div>
          <input type="text" id="apSpec_cert" placeholder="FCC, CE, RoHS"/>

          <div class="label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö (System Requirements)</div>
          <textarea id="apSpec_sysreq" placeholder="IE 11+, Firefox 12+, Chrome 20+, Safari 4+ ..."></textarea>

          <div class="label">‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥ (Operating / Storage Temperature)</div>
          <input type="text" id="apSpec_temp" placeholder="0‚Äì40 ¬∞C (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô), ‚àí40‚Äì70 ¬∞C (‡πÄ‡∏Å‡πá‡∏ö)"/>

          <div class="label">‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô (Operating / Storage Humidity)</div>
          <input type="text" id="apSpec_humi" placeholder="10‚Äì90% (‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô) / 5‚Äì90% (‡πÄ‡∏Å‡πá‡∏ö), non-condensing"/>

          <div class="label">‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô (Warranty)</div>
          <input type="text" id="apSpec_warranty" placeholder="Lifetime"/>

          <div class="label">Option / ‡∏≠‡∏∑‡πà‡∏ô ‡πÜ</div>
          <input type="text" id="apSpec_option" placeholder="N/A"/>

          <div class="label">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏ (Notes)</div>
          <textarea id="apSpec_notes" placeholder="‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏° ‡πÄ‡∏ä‡πà‡∏ô ‡∏à‡∏∏‡∏î‡∏ï‡∏¥‡∏î‡∏ï‡∏±‡πâ‡∏á, ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏π‡∏á, ‡∏™‡∏≤‡∏¢‡πÅ‡∏•‡∏ô ‡∏Ø‡∏•‡∏Ø"></textarea>
        </div>
      </details>

      <div class="row" style="margin-top:10px">
        <button id="btnAP">üì° ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏≤‡∏á AP (‡∏Ñ‡∏•‡∏¥‡∏Å)</button>
        <button id="btnAPUndo" class="ghost">‚Ü©Ô∏è ‡∏•‡∏ö AP ‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        <button id="btnAPClear" class="danger">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á AP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
      <div id="apList" style="margin-top:10px;display:grid;gap:6px;"></div>
      <div class="small muted">‡∏ß‡∏≤‡∏á‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢ AP ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏£‡∏ß‡∏°‡∏Å‡∏≥‡∏•‡∏±‡∏á (mW) ‡πÅ‡∏•‡πâ‡∏ß‡πÅ‡∏õ‡∏•‡∏á‡πÄ‡∏õ‡πá‡∏ô dBm</div>
    </div>

    <div class="section">
      <div class="label">4) ‡∏ß‡∏±‡∏™‡∏î‡∏∏/‡∏™‡∏¥‡πà‡∏á‡∏Å‡∏µ‡∏î‡∏Ç‡∏ß‡∏≤‡∏á</div>
      <div class="grid">
        <div>
          <div class="label">‡∏ä‡∏ô‡∏¥‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏</div>
          <select id="matType"></select>
        </div>
        <div>
          <div class="label">‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏î‡∏Å‡∏•‡∏∑‡∏ô (dB/‡∏Ñ‡∏£‡∏±‡πâ‡∏á)</div>
          <input type="number" id="matAtt" value="8" step="0.5"/>
        </div>
      </div>
      <div class="row" style="margin-top:8px)">
        <button id="btnMat">üß± ‡πÇ‡∏´‡∏°‡∏î‡∏ß‡∏±‡∏™‡∏î‡∏∏ (‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‚Äì‡∏•‡∏≤‡∏Å‚Äì‡∏õ‡∏•‡πà‡∏≠‡∏¢)</button>
        <button id="btnMatUndo" class="ghost">‚Ü©Ô∏è ‡∏•‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</button>
        <button id="btnMatClear" class="danger">üóëÔ∏è ‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</button>
      </div>
      <div id="matList" style="margin-top:10px;display:grid;gap:6px;"></div>
    </div>

    <div class="section">
      <div class="label">5) ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå</div>
      <div class="grid">
        <div>
          <div class="label">‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏ô‡∏µ‡∏¢‡∏ô Blur (px)</div>
          <input type="number" id="blurPx" value="16" min="0" step="1"/>
        </div>
        <div>
          <div class="label">‡πÇ‡∏õ‡∏£‡πà‡∏á‡πÉ‡∏™‡∏Æ‡∏µ‡∏ï‡πÅ‡∏°‡∏õ</div>
          <input type="number" id="alpha" value="0.6" min="0" max="1" step="0.05"/>
        </div>
      </div>
      <div class="row" style="margin-top:10px">
        <button id="btnRender">üî• ‡∏™‡∏£‡πâ‡∏≤‡∏á Heatmap</button>
        <button id="btnExport">üñºÔ∏è ‡∏™‡πà‡∏á‡∏≠‡∏≠‡∏Å PNG</button>
      </div>
      <div class="legend" style="margin-top:10px">
        <div id="grad" class="grad"></div>
        <div class="small">
          ‡∏™‡πÄ‡∏Å‡∏•‡∏™‡∏µ: ‚â§‚àí67 dBm = ‡πÄ‡∏ó‡∏≤ (‡∏≠‡πà‡∏≠‡∏ô‡∏•‡∏á‡∏à‡∏ô ‚àí80) ‚Ä¢ ‚àí60 = ‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡∏á ‚Ä¢ ‚àí30 = ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ß
        </div>
      </div>
    </div>

    <div class="section">
      <div class="label">6) ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å/‡πÇ‡∏´‡∏•‡∏î‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå</div>
      <div class="row">
        <button id="btnSave">üíæ Save JSON</button>
        <input type="file" id="loadJson" accept="application/json"/>
      </div>
    </div>

    <div class="section small muted">
      ‡∏Ñ‡∏µ‡∏¢‡πå‡∏•‡∏±‡∏î: <span class="kbd">S</span> ‡∏™‡πÄ‡∏Å‡∏• ‚Ä¢ <span class="kbd">A</span> ‡∏ß‡∏≤‡∏á AP ‚Ä¢ <span class="kbd">W</span> ‡∏ß‡∏±‡∏™‡∏î‡∏∏ ‚Ä¢ <span class="kbd">H</span> ‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå ‚Ä¢ ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏≠‡πà‡∏≤‡∏ô‡∏Ñ‡πà‡∏≤ RSSI
    </div>
  </aside>

  <!-- Right workspace -->
  <main class="panel">
    <div class="row">
      <span class="badge" id="modeBadge">‡πÇ‡∏´‡∏°‡∏î: Idle</span>
      <span class="muted small">‡∏™‡πÄ‡∏Å‡∏•/‡∏ß‡∏±‡∏™‡∏î‡∏∏ = ‡∏Å‡∏î‡∏Ñ‡πâ‡∏≤‡∏á‚Äì‡∏•‡∏≤‡∏Å‚Äì‡∏õ‡∏•‡πà‡∏≠‡∏¢ | AP = ‡∏Ñ‡∏•‡∏¥‡∏Å | Probe = ‡∏Ñ‡∏•‡∏¥‡∏Å‡∏´‡∏•‡∏±‡∏á‡πÄ‡∏£‡∏ô‡πÄ‡∏î‡∏≠‡∏£‡πå</span>
    </div>

    <div class="stage" id="stage">
      <canvas id="canvas" width="1280" height="800"></canvas>
      <canvas id="overlay" width="1280" height="800"></canvas>
      <div id="probe">
        <div><span class="sw" id="sw"></span><span id="probeVal">‚Äì dBm</span></div>
        <div class="sub" id="probeMeta"></div>
      </div>
    </div>
  </main>
</div>

<!-- Survey mode (placeholder) -->
<div class="container" id="appSurvey" style="display:none;grid-template-columns:1fr">
  <main class="panel" style="display:flex;flex-direction:column;gap:12px">
    <div class="row">
      <span class="badge">‡πÇ‡∏´‡∏°‡∏î: Survey (Placeholder)</span>
      <span class="muted small">‡∏´‡∏ô‡πâ‡∏≤‡∏ô‡∏µ‡πâ‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡πÑ‡∏ß‡πâ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ï‡πà‡∏≠</span>
    </div>
    <div class="surveyBlank">Survey Mode ‚Äî Blank Canvas</div>
  </main>
</div>

<script>
/* ===== app mode switch ===== */
let appMode = 'planning';
const modePicker = document.getElementById('modePicker');
const appPlanning = document.getElementById('appPlanning');
const appSurvey   = document.getElementById('appSurvey');
const pillPlanning = document.getElementById('pillPlanning');
const pillSurvey   = document.getElementById('pillSurvey');
const pickPlanning = document.getElementById('pickPlanning');
const pickSurvey   = document.getElementById('pickSurvey');
function setMode(mode){
  appMode = mode;
  if(mode==='planning'){
    appPlanning.style.display='grid';
    appSurvey.style.display='none';
    pillPlanning.classList.add('active');
    pillSurvey.classList.remove('active');
  }else{
    appPlanning.style.display='none';
    appSurvey.style.display='grid';
    pillPlanning.classList.remove('active');
    pillSurvey.classList.add('active');
  }
  modePicker.style.display='none';
}
pillPlanning.onclick = ()=> setMode('planning');
pillSurvey.onclick   = ()=> setMode('survey');
pickPlanning.onclick = ()=> setMode('planning');
pickSurvey.onclick   = ()=> setMode('survey');

/* ===== thresholds & utilities ===== */
const RSSI_MIN = -80;
const P_GRAY   = -67;
const P_YELLOW = -60;
const P_GREEN  = -30;

const GRAY_BASE  = [128,128,128];
const GRAY_LIGHT = [220,220,220];

const $=s=>document.querySelector(s);
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const dist=(a,b)=>Math.hypot(a.x-b.x,a.y-b.y);
const lerp=(a,b,t)=>a+(b-a)*t;
const mixColor=(c1,c2,t)=>[
  Math.round(lerp(c1[0],c2[0],t)),
  Math.round(lerp(c1[1],c2[1],t)),
  Math.round(lerp(c1[2],c2[2],t)),
];

/* ===== canvases & state ===== */
const canvas=$('#canvas'), ctx=canvas.getContext('2d',{willReadFrequently:true});
const overlay=$('#overlay'), octx=overlay.getContext('2d',{willReadFrequently:true});
let floorImg=null;
let floorScale=0.75;
let aps=[]; let segments=[];
let mode='idle'; let dragging=false; let dragStart=null;
let scale={pxPerMeter:null}; let hasRendered=false;

/* lock-n state */
let lockN=false;
let lockNValue=2.2;
const lockNEl = document.querySelector('#lockN');
const lockNValueEl = document.querySelector('#lockNValue');

/* spec form getters */
function getAPSpecFromForm(){
  return {
    model:    $('#apSpec_model').value.trim(),
    buttons:  $('#apSpec_buttons').value.trim(),
    power:    $('#apSpec_power').value.trim(),
    antenna:  $('#apSpec_ant').value.trim(),
    iface:    $('#apSpec_iface').value.trim(),
    standards:$('#apSpec_standards').value.trim(),
    rate:     $('#apSpec_rate').value.trim(),
    rx:       $('#apSpec_rx').value.trim(),
    functions:$('#apSpec_functions').value.trim(),
    cert:     $('#apSpec_cert').value.trim(),
    sysreq:   $('#apSpec_sysreq').value.trim(),
    temp:     $('#apSpec_temp').value.trim(),
    humi:     $('#apSpec_humi').value.trim(),
    warranty: $('#apSpec_warranty').value.trim(),
    option:   $('#apSpec_option').value.trim(),
    notes:    $('#apSpec_notes').value.trim(),
  };
}
function specToPrettyText(spec){
  const lines=[];
  const push=(k,v)=>{ if(v) lines.push(`${k}: ${v}`); };
  push('‡∏£‡∏∏‡πà‡∏ô/‡∏ä‡∏∑‡πà‡∏≠', spec.model);
  push('‡∏õ‡∏∏‡πà‡∏°', spec.buttons);
  push('‡πÅ‡∏´‡∏•‡πà‡∏á‡∏à‡πà‡∏≤‡∏¢‡πÑ‡∏ü', spec.power);
  push('‡πÄ‡∏™‡∏≤‡∏≠‡∏≤‡∏Å‡∏≤‡∏®', spec.antenna);
  push('‡∏û‡∏≠‡∏£‡πå‡∏ï/‡∏≠‡∏¥‡∏ô‡πÄ‡∏ó‡∏≠‡∏£‡πå‡πÄ‡∏ü‡∏ã', spec.iface);
  push('‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô/‡∏¢‡πà‡∏≤‡∏ô‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏µ‡πà', spec.standards);
  push('‡∏≠‡∏±‡∏ï‡∏£‡∏≤‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•', spec.rate);
  push('‡∏Ñ‡∏ß‡∏≤‡∏°‡πÑ‡∏ß‡∏£‡∏±‡∏ö‡∏™‡∏±‡∏ç‡∏ç‡∏≤‡∏ì', spec.rx);
  push('‡∏ü‡∏±‡∏á‡∏Å‡πå‡∏ä‡∏±‡∏ô‡πÑ‡∏£‡πâ‡∏™‡∏≤‡∏¢/‡∏Ñ‡∏ß‡∏≤‡∏°‡∏õ‡∏•‡∏≠‡∏î‡∏†‡∏±‡∏¢', spec.functions);
  push('‡πÉ‡∏ö‡∏£‡∏±‡∏ö‡∏£‡∏≠‡∏á', spec.cert);
  push('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏£‡∏∞‡∏ö‡∏ö', spec.sysreq);
  push('‡∏≠‡∏∏‡∏ì‡∏´‡∏†‡∏π‡∏°‡∏¥', spec.temp);
  push('‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ä‡∏∑‡πâ‡∏ô', spec.humi);
  push('‡∏Å‡∏≤‡∏£‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∞‡∏Å‡∏±‡∏ô', spec.warranty);
  push('Option/‡∏≠‡∏∑‡πà‡∏ô ‡πÜ', spec.option);
  push('‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏', spec.notes);
  return lines.join('\n');
}

const UI={
  modeBadge:$('#modeBadge'), scaleLabel:$('#scaleLabel'),
  apList:$('#apList'), matList:$('#matList'),
  legendMin:$('#legendMin'), legendMax:$('#legendMax'),
  probe:$('#probe'), probeVal:$('#probeVal'), probeMeta:$('#probeMeta'), probeSw:$('#sw'),
  stage:$('#stage'),
  imgScale:$('#imgScale'), imgScaleNum:$('#imgScaleNum')
};

function syncLockNUI(){
  if (!lockNEl || !lockNValueEl) return;
  lockNEl.checked = lockN;
  lockNValueEl.value = lockNValue;
  const apNInput = document.querySelector('#apN');
  if (apNInput) apNInput.disabled = lockN;
}
lockNEl?.addEventListener('change', () => {
  lockN = lockNEl.checked;
  lockNValue = parseFloat(lockNValueEl.value || '2.2');
  syncLockNUI();
  if (hasRendered) renderHeatmap();
});
lockNValueEl?.addEventListener('input', () => {
  lockNValue = parseFloat(lockNValueEl.value || '2.2');
  if (lockN && hasRendered) renderHeatmap();
});

/* ===== helpers ===== */
function getCanvasPos(e){
  const rect=canvas.getBoundingClientRect();
  const scaleX=canvas.width/rect.width, scaleY=canvas.height/rect.height;
  return { x:(e.clientX-rect.left)*scaleX, y:(e.clientY-rect.top)*scaleY, rect };
}
function download(filename,data,type="application/json"){
  const blob=new Blob([data],{type}); const url=URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download=filename; a.click();
  URL.revokeObjectURL(url);
}

/* ===== materials ===== */
const MATERIALS={
  drywall:{name:'‡∏ú‡∏ô‡∏±‡∏á‡∏¢‡∏¥‡∏õ‡∏ã‡∏±‡∏° (Drywall)',color:'#98c1ff',att:3},
  glass:{name:'‡∏Å‡∏£‡∏∞‡∏à‡∏Å',color:'#7de1ff',att:4},
  wood:{name:'‡πÑ‡∏°‡πâ',color:'#9ae27b',att:5},
  brick:{name:'‡∏≠‡∏¥‡∏ê/‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡∏°‡∏ß‡∏•‡πÄ‡∏ö‡∏≤',color:'#ffb673',att:8},
  concrete:{name:'‡∏Ñ‡∏≠‡∏ô‡∏Å‡∏£‡∏µ‡∏ï‡πÄ‡∏™‡∏£‡∏¥‡∏°‡πÄ‡∏´‡∏•‡πá‡∏Å',color:'#ff8f8f',att:12},
  metal:{name:'‡πÇ‡∏•‡∏´‡∏∞‡πÅ‡∏ú‡πà‡∏ô/‡∏õ‡∏£‡∏∞‡∏ï‡∏π‡πÄ‡∏´‡∏•‡πá‡∏Å',color:'#ffd36a',att:20},
  human:{name:'‡∏£‡πà‡∏≤‡∏á‡∏Å‡∏≤‡∏¢‡∏Ñ‡∏ô (‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢)',color:'#d6b3ff',att:3}
};
const matTypeSel=$('#matType');
for(const k of Object.keys(MATERIALS)){
  const o=document.createElement('option'); o.value=k; o.textContent=MATERIALS[k].name; matTypeSel.appendChild(o);
}
matTypeSel.value='brick'; $('#matAtt').value=MATERIALS['brick'].att;
matTypeSel.addEventListener('change',()=>$('#matAtt').value=MATERIALS[matTypeSel.value].att);

/* ===== size sync ===== */
function applyCanvasCSSSize(){
  canvas.style.width = canvas.width + 'px';
  canvas.style.height = canvas.height + 'px';
  overlay.style.width = canvas.width + 'px';
  overlay.style.height = canvas.height + 'px';
  overlay.style.left = '0px';
  overlay.style.top  = '0px';
}
function fitCanvasToImage(img){
  const maxW=1920,maxH=1080;
  const k=Math.min(maxW/img.width, maxH/img.height, 1);
  const w=Math.round(img.width*k), h=Math.round(img.height*k);
  canvas.width=w; canvas.height=h;
  overlay.width=w; overlay.height=h;
  applyCanvasCSSSize();
}
window.addEventListener('resize', applyCanvasCSSSize);

/* ===== base/permanent ===== */
function drawBase(){
  ctx.clearRect(0,0,canvas.width,canvas.height);
  if(floorImg){
    const w = Math.round(canvas.width * floorScale);
    const h = Math.round(canvas.height * floorScale);
    const x = Math.round((canvas.width - w)/2);
    const y = Math.round((canvas.height - h)/2);
    ctx.drawImage(floorImg, 0,0,floorImg.width,floorImg.height, x,y,w,h);
  }else{
    ctx.fillStyle='#0c1022'; ctx.fillRect(0,0,canvas.width,canvas.height);
    ctx.strokeStyle='#1c264a'; ctx.lineWidth=1;
    for(let x=0;x<canvas.width;x+=40){ctx.beginPath();ctx.moveTo(x,0);ctx.lineTo(x,canvas.height);ctx.stroke()}
    for(let y=0;y<canvas.height;y+=40){ctx.beginPath();ctx.moveTo(0,y);ctx.lineTo(canvas.width,y);ctx.stroke()}
  }
  hideProbe();
}
function drawPermanent(){
  ctx.lineWidth=3;
  segments.forEach(s=>{
    const m=MATERIALS[s.type]||{color:'#fff',name:s.type};
    ctx.strokeStyle=m.color; ctx.beginPath(); ctx.moveTo(s.a.x,s.a.y); ctx.lineTo(s.b.x,s.b.y); ctx.stroke();
    const mx=(s.a.x+s.b.x)/2, my=(s.a.y+s.b.y)/2;
    ctx.fillStyle='#e8ecf1'; ctx.font='11px ui-monospace,monospace';
    ctx.fillText(`${m.name} ¬∑ ${s.att} dB`, mx+6, my-6);
  });
  aps.forEach(a=>{
    ctx.fillStyle='#8fd3ff';
    ctx.beginPath(); ctx.arc(a.x,a.y,7,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='#2a7fff'; ctx.lineWidth=2; ctx.stroke();
    ctx.fillStyle='#cfe6ff'; ctx.font='12px ui-monospace,monospace';
    const nShow = (lockN?lockNValue:a.n);
    const label = a.spec?.model ? `${a.label||'AP'} (${a.spec.model})` : (a.label||'AP');
    ctx.fillText(`${label} ¬∑ P0:${a.p0}dBm n:${nShow}`, a.x+10, a.y-8);
  });
}

/* ===== overlay arrows ===== */
function clearOverlay(){ octx.clearRect(0,0,overlay.width,overlay.height); }
function drawArrow(a,b,opts={}){
  const {color='#6ae3ff',width=3.5,head=12,dash=[10,6],label=''}=opts;
  octx.save();
  octx.lineWidth=width; octx.setLineDash(dash); octx.strokeStyle=color;
  octx.beginPath(); octx.moveTo(a.x,a.y); octx.lineTo(b.x,b.y); octx.stroke();
  octx.setLineDash([]);
  const ang=Math.atan2(b.y-a.y,b.x-a.x);
  octx.beginPath();
  octx.moveTo(b.x,b.y);
  octx.lineTo(b.x-head*Math.cos(ang - Math.PI/7), b.y-head*Math.sin(ang - Math.PI/7));
  octx.lineTo(b.x-head*Math.cos(ang + Math.PI/7), b.y-head*Math.sin(ang + Math.PI/7));
  octx.closePath(); octx.fillStyle=color; octx.fill();
  octx.fillStyle='#fff'; octx.strokeStyle='#000'; octx.lineWidth=2;
  [a,b].forEach(p=>{ octx.beginPath(); octx.arc(p.x,p.y,4,0,Math.PI*2); octx.fill(); octx.stroke(); });
  if(label){ octx.font='12px ui-monospace,monospace'; octx.fillStyle='#cfe6ff'; octx.fillText(label, b.x+10, b.y-8); }
  octx.restore();
}

/* ===== legend & color ===== */
function makeFixedLegend(){
  const g=$('#grad'); const cvs=document.createElement('canvas'); cvs.width=256; cvs.height=1;
  const c=cvs.getContext('2d');

  const span1 = P_GRAY - RSSI_MIN;
  const span2 = P_YELLOW - P_GRAY;
  const span3 = P_GREEN - P_YELLOW;
  const spanSum = span1 + span2 + span3;
  const usable = 240;
  const s = usable / spanSum;

  const px1 = Math.round(span1 * s);
  const px2 = Math.round(span2 * s);
  const px3 = Math.round(span3 * s);
  const pxG = 256 - (px1+px2+px3);

  let x = 0;
  for(let i=0;i<px1;i++,x++){
    const t = i/(px1||1);
    const col = mixColor(GRAY_LIGHT, GRAY_BASE, t);
    c.fillStyle = `rgb(${col[0]},${col[1]},${col[2]})`;
    c.fillRect(x,0,1,1);
  }
  for(let i=0;i<px2;i++,x++){
    const t = i/(px2||1);
    const col = mixColor(GRAY_BASE, [255,255,0], t);
    c.fillStyle = `rgb(${col[0]},${col[1]},${col[2]})`;
    c.fillRect(x,0,1,1);
  }
  for(let i=0;i<px3;i++,x++){
    const t = i/(px3||1);
    const col = mixColor([255,255,0], [0,255,0], t);
    c.fillStyle = `rgb(${col[0]},${col[1]},${col[2]})`;
    c.fillRect(x,0,1,1);
  }
  c.fillStyle = `rgb(0,255,0)`;
  c.fillRect(x,0,pxG,1);

  g.style.backgroundImage=`url(${cvs.toDataURL()})`;
}
function colorFromRSSI(v){
  if (v <= P_GRAY){
    const t = clamp((P_GRAY - v) / (P_GRAY - RSSI_MIN), 0, 1);
    return mixColor(GRAY_BASE, GRAY_LIGHT, t);
  }
  if (v <= P_YELLOW){
    const t = (v - P_GRAY) / (P_YELLOW - P_GRAY);
    return mixColor(GRAY_BASE, [255,255,0], t);
  }
  if (v <= P_GREEN){
    const t = (v - P_YELLOW) / (P_GREEN - P_YELLOW);
    return mixColor([255,255,0], [0,255,0], t);
  }
  return [0,255,0];
}
const rgbStr=([r,g,b])=>`rgb(${r},${g},${b})`;

/* ===== geometry & obstacle loss ===== */
function orient(a,b,c){ return (b.x-a.x)*(c.y-a.y) - (b.y-a.y)*(c.x-a.x); }
function onSeg(a,b,c){ return Math.min(a.x,b.x)-1e-6<=c.x && c.x<=Math.max(a.x,b.x)+1e-6 &&
                             Math.min(a.y,b.y)-1e-6<=c.y && c.y<=Math.max(a.y,b.y)+1e-6; }
function segIntersect(p1,p2,q1,q2){
  const o1=orient(p1,p2,q1),o2=orient(p1,p2,q2),o3=orient(q1,q2,p1),o4=orient(q1,q2,p2);
  if((o1*o2<0)&&(o3*o4<0)) return true;
  if(Math.abs(o1)<1e-8 && onSeg(p1,p2,q1)) return true;
  if(Math.abs(o2)<1e-8 && onSeg(p1,p2,q2)) return true;
  if(Math.abs(o3)<1e-8 && onSeg(q1,q2,p1)) return true;
  if(Math.abs(o4)<1e-8 && onSeg(q1,q2,p2)) return true;
  return false;
}
function pathObstacleLoss(pFrom,pTo){
  let loss=0; for(const s of segments){ if(segIntersect(pFrom,pTo,s.a,s.b)) loss+=(+s.att||0); } return loss;
}

/* ===== AP model ===== */
// RSSI(d) = P0 - 10*n*log10(d) - obstacleLoss ; d (m)
function rssiFromAPs(x,y){
  if(!aps.length) return RSSI_MIN;
  if(!scale.pxPerMeter) return RSSI_MIN;
  const P={x,y}; let sum_mW=0;
  for(const a of aps){
    const d_px=Math.hypot(x-a.x,y-a.y);
    const d_m=Math.max(1e-3,d_px/scale.pxPerMeter);
    const lossObs=pathObstacleLoss(P,a);
    const nEff = lockN ? lockNValue : a.n;
    const rssi=a.p0 - 10*nEff*Math.log10(d_m) - lossObs;
    sum_mW += Math.pow(10, rssi/10);
  }
  return 10*Math.log10(Math.max(1e-15,sum_mW));
}

/* ===== heatmap render ===== */
function renderHeatmap(){
  if(!floorImg) return;
  if(aps.length===0) return;

  const alpha=clamp(parseFloat($('#alpha').value||'0.6'),0,1);
  const blurPx=Math.max(0,parseInt($('#blurPx').value||'16',10));
  makeFixedLegend();
  drawBase();

  const heat=document.createElement('canvas'); heat.width=canvas.width; heat.height=canvas.height;
  const hctx=heat.getContext('2d',{willReadFrequently:true});
  let img=hctx.createImageData(heat.width,heat.height), arr=img.data;
  for(let y=0;y<heat.height;y++){
    for(let x=0;x<heat.width;x++){
      const rssi=rssiFromAPs(x,y); const [r,g,b]=colorFromRSSI(rssi);
      const i=(y*heat.width+x)*4; arr[i]=r; arr[i+1]=g; arr[i+2]=b; arr[i+3]=255;
    }
  }
  hctx.putImageData(img,0,0);
  ctx.save(); ctx.globalAlpha=alpha; if(blurPx>0) ctx.filter=`blur(${blurPx}px)`;
  ctx.drawImage(heat,0,0); ctx.filter='none'; ctx.restore();
  drawPermanent(); hasRendered=true;
}

/* ===== probe ===== */
function showProbeAt(x,y,rect){
  ctx.save(); ctx.beginPath(); ctx.arc(x,y,6,0,Math.PI*2); ctx.fillStyle='#fff'; ctx.globalAlpha=.9; ctx.fill();
  ctx.lineWidth=2; ctx.strokeStyle='#000'; ctx.globalAlpha=1; ctx.stroke(); ctx.restore();
  const rssi=rssiFromAPs(x,y), col=colorFromRSSI(rssi), colStr=rgbStr(col);
  $('#probeVal').textContent=`${rssi.toFixed(1)} dBm`;
  $('#probeMeta').textContent=`x=${x|0}, y=${y|0}`;
  $('#sw').style.background=colStr;

  const stageRect=UI.stage.getBoundingClientRect(); const cRect=canvas.getBoundingClientRect();
  const px=(x/canvas.width)*cRect.width + (cRect.left-stageRect.left);
  const py=(y/canvas.height)*cRect.height + (cRect.top-stageRect.top);
  UI.probe.style.left=`${px}px`; UI.probe.style.top=`${py}px`; UI.probe.style.display='block';
}
function hideProbe(){ UI.probe.style.display='none'; }

/* ===== lists ===== */
function escapeHtml(s){ return s.replace(/[&<>"']/g,m=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function refreshAPList(){
  UI.apList.innerHTML='';
  aps.forEach((a,i)=>{
    const row=document.createElement('div'); row.className='apRow small';
    const model = a.spec?.model ? ` (${escapeHtml(a.spec.model)})` : '';
    row.innerHTML=`<div>
        <strong>${escapeHtml(a.label||'AP')}${model}</strong> ¬∑ P0:${a.p0} dBm ¬∑ n:${lockN?lockNValue:a.n}
        <div class="muted">(${a.x|0},${a.y|0})</div>
      </div>
      <div class="row">
        <button data-i="${i}" class="ghost" style="padding:4px 8px">‚ÑπÔ∏è ‡∏™‡πÄ‡∏õ‡∏Å</button>
        <button data-del="${i}" class="danger" style="padding:4px 8px">‡∏•‡∏ö</button>
      </div>`;
    const infoBtn = row.querySelector('button.ghost');
    infoBtn.onclick = e=>{
      const idx = +e.target.getAttribute('data-i');
      const spec = aps[idx]?.spec||{};
      const text = specToPrettyText(spec)||'(‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡πÄ‡∏õ‡∏Å‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å)';
      alert(text);
    };
    row.querySelector('button[data-del]').onclick=e=>{
      aps.splice(+e.target.getAttribute('data-del'),1);
      drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshAPList();
    };
    UI.apList.appendChild(row);
  });
}
function refreshMatList(){
  UI.matList.innerHTML='';
  segments.forEach((s,i)=>{
    const m=MATERIALS[s.type]||{name:s.type,color:'#fff'};
    const row=document.createElement('div'); row.className='matRow small';
    row.innerHTML=`<div style="display:flex;align-items:center;gap:8px">
        <span class="dot" style="background:${m.color}"></span>
        <div><div><strong>${m.name}</strong> ¬∑ ${s.att} dB</div>
        <div class="muted">A(${s.a.x|0},${s.a.y|0}) ‚Üí B(${s.b.x|0},${s.b.y|0})</div></div>
      </div>
      <div class="row"><button data-i="${i}" class="danger" style="padding:4px 8px">‡∏•‡∏ö</button></div>`;
    row.querySelector('button').onclick=e=>{
      segments.splice(+e.target.getAttribute('data-i'),1);
      drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshMatList();
    };
    UI.matList.appendChild(row);
  });
}

/* ===== toolbar ===== */
$('#btnScale').onclick=()=>{ mode='scale'; UI.modeBadge.textContent='‡πÇ‡∏´‡∏°‡∏î: ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•'; hideProbe(); };
$('#btnAP').onclick   =()=>{ mode='ap';    UI.modeBadge.textContent='‡πÇ‡∏´‡∏°‡∏î: ‡∏ß‡∏≤‡∏á AP (‡∏Ñ‡∏•‡∏¥‡∏Å)'; hideProbe(); };
$('#btnMat').onclick  =()=>{ mode='mat';   UI.modeBadge.textContent='‡πÇ‡∏´‡∏°‡∏î: ‡∏ß‡∏±‡∏™‡∏î‡∏∏ (‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô)'; hideProbe(); };

$('#btnAPUndo').onclick =()=>{ aps.pop(); drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshAPList(); };
$('#btnAPClear').onclick=()=>{ if(confirm('‡∏•‡πâ‡∏≤‡∏á AP ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ aps=[]; drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshAPList(); } };

$('#btnMatUndo').onclick =()=>{ segments.pop(); drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshMatList(); };
$('#btnMatClear').onclick=()=>{ if(confirm('‡∏•‡πâ‡∏≤‡∏á‡∏ß‡∏±‡∏™‡∏î‡∏∏‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?')){ segments=[]; drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshMatList(); } };

$('#btnRender').onclick =()=>{ renderHeatmap(); hideProbe(); };
$('#btnExport').onclick =()=>{ const a=document.createElement('a'); a.download='heatmap.png'; a.href=canvas.toDataURL('image/png'); a.click(); };

/* Save/Load */
$('#btnSave').onclick=()=>{
  const payload={ aps, segments,
                  alpha:+($('#alpha').value||0.6),
                  blurPx:+($('#blurPx').value||16),
                  scale:scale.pxPerMeter, floorScale,
                  lockN, lockNValue };
  download('heatmap_project_planning.json', JSON.stringify(payload,null,2));
};
$('#loadJson').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const reader=new FileReader();
  reader.onload=()=>{
    try{
      const obj=JSON.parse(reader.result);
      aps=(obj.aps||[]).map(a=>({ ...a, spec:a.spec||{} })); // ensure spec
      segments=obj.segments||[];
      $('#alpha').value=obj.alpha??0.6; $('#blurPx').value=obj.blurPx??16;
      scale.pxPerMeter=obj.scale||null;
      floorScale = clamp(obj.floorScale ?? floorScale, 0.2, 1.5);
      lockN = !!obj.lockN;
      lockNValue = parseFloat(obj.lockNValue ?? 2.2);
      UI.imgScale.value = Math.round(floorScale*100);
      UI.imgScaleNum.value = Math.round(floorScale*100);
      UI.scaleLabel.textContent=scale.pxPerMeter?`${(scale.pxPerMeter).toFixed(1)} px/‡πÄ‡∏°‡∏ï‡∏£`:'‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏ï‡∏±‡πâ‡∏á';
      syncLockNUI();
      drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent();
      refreshAPList(); refreshMatList();
    }catch(err){ console.error('Invalid project JSON', err); }
  };
  reader.readAsText(f);
});

/* ===== image I/O ===== */
$('#fileInput').addEventListener('change', e=>{
  const f=e.target.files[0]; if(!f) return;
  const img=new Image(); img.onload=()=>{ floorImg=img; fitCanvasToImage(img); drawBase(); drawPermanent(); };
  img.src=URL.createObjectURL(f);
});
$('#btnClear').onclick=()=>{ floorImg=null; drawBase(); drawPermanent(); };

/* ===== drag on canvas ===== */
function startDrag(x,y){ dragging=true; dragStart={x,y}; clearOverlay(); }
function updateDrag(x,y){
  if(!dragging||!dragStart) return;
  clearOverlay();
  const label=(mode==='scale')
    ? `${dist(dragStart,{x,y}).toFixed(1)} px`
    : `${MATERIALS[$('#matType').value]?.name||'‡∏ß‡∏±‡∏™‡∏î‡∏∏'} ¬∑ ${($('#matAtt').value||'0')} dB`;
  const color=(mode==='scale')?'#6ae3ff':'#ffd36a';
  drawArrow(dragStart,{x,y},{color, width:3.5, head:12, dash:[10,6], label});
}
function endDrag(x,y){
  if(!dragging||!dragStart) return;
  clearOverlay();
  const a={...dragStart}, b={x,y};
  if(mode==='scale'){
    const Lpx=dist(a,b);
    const real=prompt(`‡∏Ñ‡∏ß‡∏≤‡∏°‡∏¢‡∏≤‡∏ß‡∏à‡∏£‡∏¥‡∏á (‡πÄ‡∏°‡∏ï‡∏£) ‡∏Ç‡∏≠‡∏á‡πÑ‡∏°‡πâ‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ${Lpx.toFixed(1)} px = ?`, '5');
    if(real && +real>0){
      scale.pxPerMeter=Lpx/(+real);
      UI.scaleLabel.textContent=`${scale.pxPerMeter.toFixed(1)} px/‡πÄ‡∏°‡∏ï‡∏£`;
    }
    mode='idle'; UI.modeBadge.textContent='‡πÇ‡∏´‡∏°‡∏î: Idle';
    drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent();
  }else if(mode==='mat'){
    const type=$('#matType').value;
    const att=parseFloat($('#matAtt').value || (MATERIALS[type]?.att||8));
    segments.push({a,b,type,att});
    mode='idle'; UI.modeBadge.textContent='‡πÇ‡∏´‡∏°‡∏î: Idle';
    drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshMatList();
  }
  dragging=false; dragStart=null;
}

/* mouse binding */
canvas.addEventListener('mousedown', e=>{
  if(appMode!=='planning') return;
  const {x,y}=getCanvasPos(e);
  if(mode==='scale' || mode==='mat') startDrag(x,y);
});
canvas.addEventListener('mousemove', e=>{
  if(appMode!=='planning') return;
  const {x,y}=getCanvasPos(e);
  if(mode==='scale' || mode==='mat') updateDrag(x,y);
});
canvas.addEventListener('mouseup', e=>{
  if(appMode!=='planning') return;
  const {x,y}=getCanvasPos(e);
  if(mode==='scale' || mode==='mat') endDrag(x,y);
});
canvas.addEventListener('mouseleave', ()=>{ if(appMode!=='planning') return; dragging=false; dragStart=null; clearOverlay(); });

/* click for AP / probe */
canvas.addEventListener('click', e=>{
  if(appMode!=='planning') return;
  const {x,y,rect}=getCanvasPos(e);
  if(mode==='ap'){
    if(!scale.pxPerMeter) return;
    const label=$('#apLabel').value.trim()||`AP-${aps.length+1}`;
    const p0=parseFloat($('#apP0').value||'-40');
    const n  = lockN ? lockNValue : parseFloat($('#apN').value||'2.2');
    const spec = getAPSpecFromForm();
    aps.push({x,y,label,p0,n,spec});
    drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent(); refreshAPList();
  }else if(mode==='idle'){
    if(!hasRendered) return;
    renderHeatmap(); showProbeAt(x,y,rect);
  }
});

/* keyboard (Planning) */
document.addEventListener('keydown', e=>{
  if(appMode!=='planning') return;
  if(e.key==='s'||e.key==='S'){ mode='scale'; UI.modeBadge.textContent='‡πÇ‡∏´‡∏°‡∏î: ‡∏ï‡∏±‡πâ‡∏á‡∏™‡πÄ‡∏Å‡∏•'; hideProbe(); }
  if(e.key==='a'||e.key==='A'){ mode='ap';    UI.modeBadge.textContent='‡πÇ‡∏´‡∏°‡∏î: ‡∏ß‡∏≤‡∏á AP (‡∏Ñ‡∏•‡∏¥‡∏Å)'; hideProbe(); }
  if(e.key==='w'||e.key==='W'){ mode='mat';   UI.modeBadge.textContent='‡πÇ‡∏´‡∏°‡∏î: ‡∏ß‡∏±‡∏™‡∏î‡∏∏ (‡∏•‡∏≤‡∏Å‡πÄ‡∏™‡πâ‡∏ô)'; hideProbe(); }
  if(e.key==='h'||e.key==='H'){ renderHeatmap(); hideProbe(); }
});

/* floor scale controls */
function setFloorScaleFromInput(v){
  const pct = clamp(parseInt(v,10)||75, 20, 150);
  UI.imgScale.value = pct;
  UI.imgScaleNum.value = pct;
  floorScale = pct/100;
  drawBase(); if(hasRendered) renderHeatmap(); else drawPermanent();
}
UI.imgScale.addEventListener('input', e=> setFloorScaleFromInput(e.target.value));
UI.imgScaleNum.addEventListener('input', e=> setFloorScaleFromInput(e.target.value));

/* init */
(function init(){
  applyCanvasCSSSize();
  syncLockNUI();
  drawBase(); drawPermanent();
})();
</script>
</body>
</html>
